#include "./device.h"

struct timeval tv = { 0,1000};	//0.01s 闂傚倷娴囧畷鍨叏閺夋嚚娲煛閸滀焦鏅悷婊勫灴婵＄敻骞囬悧鍫熸闂佽法鍣﹂幏锟�
AD_data AD_DATA = {
    .rudder = 0.0,
    .vol = 0.0,
    .mutex = PTHREAD_MUTEX_INITIALIZER  // 闂傚倸鍊搁崐鎼佸磹閹间焦鍋嬪┑鐘叉处閸嬶繝鏌ㄩ弴鐐测偓鎼佹倿閸偁浜滈柟杈剧稻绾埖銇勯敂鑲╃暤闁哄本鐩俊鎼佸Ψ瑜岀划鐢告⒑闁稓鈹掗柛鏂块叄閸┾偓妞ゆ帒锕︾粔闈浢瑰⿰鍕煉妞ゃ垺淇洪ˇ瑙勬叏婵犲嫬鍔嬬€垫澘瀚板畷顐﹀Ψ瑜忛幗宀€绱撻崒娆愮グ濡炲瓨鎮傞幃鐑芥晝閸屾せ鍋撻弮鍫濈劦妞ゆ帊妞掔换鍡樸亜閺嶃劋绶遍柛搴涘劦閺屾稑顫濋浣告灎闂佸搫鐭夌换婵嗙暦婵傚壊鏁冮柨鐔哄Т娴犳劙姊绘担濮愨偓鈧柛瀣崌閺屻劌鈹戦崱妯碱槺闂佺ǹ顑嗛幐楣冨箟閹绢喖绀嬫い鎾跺仦濞堝湱绱撻崒娆戝妽闁哥偛顭烽獮蹇涙晸閿燂拷
};

//闂傚倸鍊搁崐鎼佸磹閹间礁纾瑰瀣捣閻棗銆掑锝呬壕濡ょ姷鍋為悧鐘汇€侀弴銏℃櫇闁逞屽墰婢规洟宕烽鐘碉紲闁诲函缍嗛崑鎾舵閳哄倻绠剧€瑰壊鍠曠花濂告煛閸涱喚鍙€闁哄本绋戦埥澶愬矗濡厧鍤梻浣筋嚙妤犳悂鈥﹀畡閭︽綎婵炲樊浜濋ˉ鍫熺箾閹寸偞鐨戦柣銈呭濮婅櫣绮欓崠鈩冩暰濠电偛寮剁划搴ㄥ礆閹烘挾绡€婵﹩鍘兼禒娲⒑閸涘﹦缂氶柛搴ょ簿閵囨劙宕熼娑掓嫼闂佺鍋愰崑娑㈠礉濮椻偓閺屾盯寮捄銊ь唹缂備焦姊婚崰搴綖濠婂牆鐒垫い鎺戝閽冪喖鏌ㄥ┑鍡樺晵闁哄啠鍋撻柟宄版嚇瀹曠兘顢橀悤浣告倠缂傚倸鍊搁崐宄懊归崶銊ｄ粓闁告縿鍎查弳婊堟煙閻戞ɑ绀堝ù婊勭懇濮婅櫣鎷犻幓鎺戞瘣缂傚倸绉村Λ婵嗙暦濠婂啠妲堥柕蹇曞У鏉堝牓姊虹紒姗嗙劷缂侇噮鍨堕崺娑㈠箣閿旂晫鍘甸梺鍏肩ゴ閺呮稒绂掑⿰鍐ｆ斀闁炽儳鍋ㄩ崑銏ゆ煛瀹€瀣К缂佺姵鐩顒勫垂椤旇姤鍤堝┑掳鍊楁慨鐑藉磻濞戙垺鍋嬮柟鍓х節缁诲棙鎱ㄥ┑鍡欑劸婵¤尙鍏樺铏圭矙濞嗘儳鍓遍梺鍦嚀濞差厼顕ｉ锕€绠涙い鎾跺枎閸斿懎鈹戦悩缁樻锭闁绘绻愰埢鏃堝箰鎼存繄绠氶梺缁樺姦娴滄粓鍩€椤掍胶澧悡銈夋煃閸濆嫭鍣圭紒鐙€鍨堕弻銊╂偆閸屾稑顏�
void fd_initialize(){
	//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柣鎴ｅГ閸ゅ嫰鏌ら崫銉︽毄濞寸姵宀稿娲嚒閵堝懍娌梺鍛婂灥缂嶅﹤鐣烽幋鐐电瘈闁稿本绮嶅▓鎯р攽閻樼粯娑ф俊顐ｇ洴瀵娊宕卞☉娆戝幈闂佸搫娲㈤崝灞炬櫠椤旀祹褰掓偐鐠佽櫕鍠氬┑顔硷攻濡炶棄螞閸愵煁褰掑Ψ閵壯冣叺閻庢鍠楄ぐ鍐煡婢跺á鐔封堪閸曨厸妲堝銈庡亝缁捇宕洪埀顒併亜閹烘垵顏╅柦鍐枑缁绘盯骞嬪▎蹇曚患闁哥儐鍨伴—鍐Χ閸℃瑥鈷堥梺绋款儑閸嬨倝銆侀幘鎰佸悑闁告粈鐒︾€靛矂姊洪棃娑氬婵☆偅顨嗛幈銊樄闁哄瞼鍠栧畷娆撳Χ閸℃浼�
	file_data = fopen("data/output.csv", "a");
    if (file_data== NULL) {
        perror("Failed to open file");
        return; 
    }
   	printf(file_data, "\xEF\xBB\xBF");  // UTF-8 BOM
    fprintf(file_data, "时间戳,数字标签,经度,纬度,艏向,角速度,x坐标,向北速度,y坐标,向东速度,期望艏向,期望速度,期望角速度,期望舵角,期望推进器电压,舵角积分补偿,航速,实际舵角,实际推进器电压,艏PG1,艏PG2,艏PG3,角PG1,角PG2,角PG3,速PG1,速PG2,速PG3\n");
	if ((fd[0] = open_port(fd[0], 12)) < 0) { 
		perror("open_port error...tmt");
		return;
	}

	if ((fd_i[0] = set_opt(fd[0], 19200, 8, 'N', 1)) < 0) {
		perror("set_opt error...tmt");
		return;
	}
	if ((fd[1] = open_port(fd[1], 7)) < 0) {
		perror("open_port error...rudder");
		return;
	}
	if ((fd_i[1] = set_opt(fd[1], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...rudder");
		return;
	}

	if ((fd_NV = open_port(fd_NV, 4)) < 0) {
		perror("open_port error...NV");
		return;
	}
	if ((fd_i_NV= set_opt(fd_NV, 115200, 8, 'N', 1)) < 0) {
		perror("set_opt error...NV");
		return;
	}

	if ((fd[5] = open_port(fd[5], 5)) < 0) {  //闂傚倸鍊峰ù鍥綖婢跺顩插ù鐘差儏缁€澶愮叓閸ャ劍绀冪€规洖寮堕幈銊ヮ渻鐠囪弓澹曢柣搴ゎ潐濞叉ɑ绻涙繝鍥ф瀬闁瑰墽绮弲鎼佹煥閻曞倹瀚�
		perror("open_port error...thrust");
		return;
	}
	if ((fd_i[5] = set_opt(fd[5], 9600, 8, 'N', 1)) < 0) {// 闂傚倸鍊峰ù鍥綖婢跺顩插ù鐘差儏缁€澶愮叓閸ャ劍绀冪€规洖寮堕幈銊ヮ渻鐠囪弓澹曢柣搴ゎ潐濞叉ɑ绻涙繝鍥ф瀬闁瑰墽绮弲鎼佹煥閻曞倹瀚�
		perror("set_opt error...thrust");
		return;
	}
	if ((fd[6] = open_port(fd[6], 1)) < 0) {   //AD
		perror("open_port error...AD");
		return;
	}
	if ((fd_i[6] = set_opt(fd[6], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...AD");
		return;
	}
	printf("port has been open\n");


	int i;
    for ( i = 0; i < FD_NUM; i++) {
        FD_ZERO(&rd[i]);            
	    FD_SET(fd[i], &rd[i]);      
	    maxfd[i] = fd[i];           
    }
	
	FD_SET(fd_NV, &rd_NV);
	maxfd_NV = fd_NV;
}


void fd_cleanup() {
    int i;
    
    // Close all file descriptors in fd array
    for (i = 0; i < FD_NUM; i++) {
        if (fd[i] >= 0) {
            close(fd[i]);
            fd[i] = -1;
        }
    }
    
    // Close NV file descriptor
    if (fd_NV >= 0) {
        close(fd_NV);
        fd_NV = -1;
    }
    
    // Close the data file
    if (file_data != NULL) {
        fclose(file_data);
        file_data = NULL;
    }
    
    // Clear all file descriptor sets
    for (i = 0; i < FD_NUM; i++) {
        FD_ZERO(&rd[i]);
        maxfd[i] = -1;
    }
    
    FD_ZERO(&rd_NV);
    maxfd_NV = -1;
    
    printf("file descriptor has been cleaned");
}
//闂傚倸鍊搁崐鎼佸磹閹间礁纾圭€瑰嫭鍣磋ぐ鎺戠倞妞ゆ巻鍋撶痪鎯ь煼閺岀喖鏌囬敃鈧獮妯好归悩鍐插摵婵﹦绮幏鍛驳鐎ｎ亝顔勭紓鍌欒兌缁垶宕归崸妤€绠犳繝闈涙储閸嬪懘鏌涢幇鈺佸闁告ɑ鎸冲娲川婵犲倸袝闂佸摜濮甸悧鐘诲箖閻愮儤鍋ㄩ柛娑橈功閸欏棝姊虹紒妯荤闁稿﹤婀遍埀顒佺啲閹凤拷
void pwm_rudder(double rudder){
		memset(buff_temp, 0, sizeof(buff_temp));//婵犵數濮烽弫鍛婃叏閻戣棄鏋侀柛娑橈攻閸欏繘鏌ｉ幋锝嗩棄闁哄绶氶弻娑樷槈濮楀牊鏁鹃梺鍛婄懃缁绘﹢寮婚敐澶婄闁挎繂妫Λ鍕⒑閸濆嫷鍎庣紒鑸靛哺瀵鎮㈤崗灏栨嫽闁诲酣娼ф竟濠偽ｉ鍓х＜闁绘劦鍓欓崝銈嗐亜椤撶姴鍘寸€殿喖顭烽弫鎰緞婵犲嫮鏉告俊鐐€栫敮濠囨倿閿曞倸纾块柟鎯у绾捐棄霉閿濆懏鎯堢亸蹇涙⒑閸涘⿴娈曞┑鐐诧工椤曪絾绻濆顓炰簻闂佺ǹ绻愰惃鐑藉箯婵犳碍鐓熼幖娣妽濞懷冾熆閻熷府宸ラ崡杈ㄣ亜閺傚灝鈷旂痪鎹愭闇夐柨婵嗘噺閹牓宕崨濠勭瘈闁汇垽娼ф禍褰掓煕鐎ｎ偅宕屾慨濠冩そ瀹曨偊宕熼鐘辩礃闂備礁鎽滄慨鐢告偋閻樿崵宓侀柛鎰靛弾濡嫰鎮楃憴鍕闁靛牊鎮傞獮鍐閵堝懍绱堕梺鍛婃处閸嬪懘顢樻總鍛娾拻闁稿本鑹鹃埀顒傚厴閹虫宕滄担绋跨亰濡炪倖鐗滈崑娑氱不閺夊簱鏀介柣妯虹－椤ｆ煡鏌￠崨顔剧疄闁哄本娲濈粻娑氣偓锝庝簴閸嬫捇寮撮姀鈥崇彅闂佺粯鏌ㄩ崥瀣偂閸愵喗鐓忓鑸电〒閻ｅ崬顭胯閸ㄥ爼寮诲☉姗嗘僵妞ゆ帒顦崜璺何旈悩闈涗沪闁绘绮撳畷姘跺箳濡も偓缁€鍌氼熆鐠虹尨姊楀瑙勬礋濮婃椽鎳栭埞鐐珱闂佸憡鎸婚惄顖氱暦閸濆嫷鍚嬪璺侯儌閹峰姊虹粙鎸庢拱闁荤喆鍔戝畷妤€鐣濋崟顐㈠殤濡炪倕绻愰幊灞剧濠婂牊鐓欓悗娑欘焽缁犳牗銇勯妷锝呯仾妞ゃ劊鍎甸幃娆撳级閹存繍娼氭俊銈囧Х閸嬬偤鎮уΔ鍛闁告稒娼欐导鐘绘煏婢跺牆鍔氱紓浣叉櫆缁绘繈鎮介棃娴剁偤鏌涢妸褍甯堕柍缁樻煥閳藉饪伴崘鐐緭闂傚倸鍊风粈渚€骞栭锔绘晞闁告侗鍨崑鎾斥槈閹烘挻鐝曠紓浣哥焷妞村摜鎹㈠┑瀣倞闁肩ǹ鐏氬▍鏍ㄧ節閻㈤潧鈻堟繛浣冲吘娑樜旈崨顓犵暰闂佺粯鍔楅崕銈夊煕閹达附鐓曟繝闈涙椤忣亪鏌ㄥ☉妯夹ч柡灞剧☉铻ｉ柛顭戝暕閹惧墎纾肩€光偓閸愵喖鎽电紓浣虹帛缁诲牆鐣烽崼鏇炍╅柕澶堝灩娴滈箖姊洪崹顕呭剭濞存粍绮撻悡顐﹀炊閵婏箑纰嶅銈呯箞閸婃繈寮诲☉姘ｅ亾閿濆骸浜濈€规洖鐬奸埀顒侇問閸犳洜鍒掑▎鎾扁偓浣割潨閳ь剟骞冨▎鎴斿亾濞戞瑯鐒烘慨姗嗗厴閺€浠嬫煟濡櫣浠涢柡鍡忔櫅閳规垿顢欓懞銉х▏闁绘挶鍊濋弻鏇㈠醇濠靛洤绐涙繛鎴炴尭缁夌敻濡甸崟顖氬唨妞ゆ劦婢€濞岊亪姊虹紒妯诲蔼闁稿海鏁诲濠氭晲婢跺﹤宓嗛梺缁樺姈缁佹挳宕戦幘璇叉嵍妞ゆ挻绋戞禍鐐叏濡厧浜鹃悗姘炬嫹
		rudder=rudder-5;
		// if (fabs(CTRL_DATA_PSI.yd_1[0]-CTRL_DATA_PSI.y_1[0])<=10){
		// 		rudder*=0.7;
		// }
		rudder = -rudder;
		if ((rudder < 10) && (rudder >= 0))
		{
			sprintf(buff_temp, "$0%d;", (int)round(fabs(rudder)));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鐐劤缂嶅﹪寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閹冣挃闁硅櫕鎹囬垾鏃堝礃椤忎礁浜鹃柨婵嗙凹缁ㄥジ鏌熼惂鍝ョМ闁哄矉缍侀、姗€鎮欓幖顓燁棧闂備線娼уΛ娆戞暜閹烘缍栨繝闈涱儐閺呮煡鏌涘☉鍗炲妞ゃ儲鑹鹃埞鎴炲箠闁稿﹥顨嗛幈銊╂倻閽樺锛涘┑鐐村灍閹崇偤宕堕浣镐缓缂備礁顑嗙€笛囨倵椤掑嫭鈷戦柣鐔告緲閳锋梻绱掗鍛仸鐎规洘鍨块獮鍥偋閸垹骞樼紓浣哄亾濠㈡ê鐣烽浣规珷缂備焦眉缁诲棝鏌ょ喊鍗炲闁告ê鐡ㄩ幈銊︾節閸曨厼绗￠梺鐟板槻閹虫ê鐣烽妸锔剧瘈闁告劑鍔屾竟宥囩磽閸屾艾鈧绮堟笟鈧、鏍礋椤撶噥鍋ㄥ┑顔斤供閸撴盯寮抽敃鍌涚厪闊洢鍎崇壕鎸庛亜閳哄啫鍘撮柟顔筋殜閺佹劖鎯斿┑鍫熸櫦闂備焦瀵х粙鎺楁儎椤栨凹娼栭柧蹇氼潐瀹曞鏌曟繛鍨姕闁诲繋鐒︾换婵嗏枔閸喗鐏撻梺杞扮椤兘鐛崘顔筋€愮紓浣哄У閻╊垶鐛▎鎾崇妞ゅ繐瀚弳鈺呮⒒娴ｈ棄鍚瑰┑顔藉劤閳诲秹鏁愭径濠勶紵闂侀潧鐗嗛敍鍡樺緞閹邦厼鈧兘鎮楅棃娑欐喐妞ゆ梹娲熷娲川婵犱胶绻侀梺鍛娒肩划娆忕暦閻㈢ǹ鐐婃い鎺嶈兌閸樻悂鎮楅崗澶婁壕闁诲函缍嗛崜娑溾叺濠碉紕鍋戦崐鎴﹀垂濞差亝鏅濋柕蹇嬪€曠粻鏍煏閸繃顥炲┑顖涙尦閺屾盯鏁傜拠鎻掔濠电姰鍨虹敮鈥愁潖婵犳艾纾兼繛鍡樺焾濡差噣姊洪崷顓涙嫛闁稿妫濋獮鍐敋閳ь剟銆侀弴銏℃櫇闁逞屽墰缁牊寰勯幇顓犲幍闁哄鐗嗘晶浠嬫偩鏉堚晝纾奸柣妯虹－婢х敻鏌＄仦鐐鐎规洜鍘ч埞鎴﹀箛椤撳濡囩槐鎺楁倷椤掆偓閸斻倝鏌涘顒夊剳闁瑰箍鍨归埥澶愬閻樻鍚呴梻浣虹帛閸ㄩ潧煤閿濆洦顐介柛顭戝亞缁犻箖鎮楅崹顐ｅ仩闁逞屽墮椤戝鐛箛娑欐櫢闁跨噦鎷� 
		}
		else if ((rudder< 0) && (rudder> -10))
		{

			sprintf(buff_temp, "$-0%d;", (int)round(fabs(rudder)));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鐐劤缂嶅﹪寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閹冣挃闁硅櫕鎹囬垾鏃堝礃椤忎礁浜鹃柨婵嗙凹缁ㄥジ鏌熼惂鍝ョМ闁哄矉缍侀、姗€鎮欓幖顓燁棧闂備線娼уΛ娆戞暜閹烘缍栨繝闈涱儐閺呮煡鏌涘☉鍗炲妞ゃ儲鑹鹃埞鎴炲箠闁稿﹥顨嗛幈銊╂倻閽樺锛涘┑鐐村灍閹崇偤宕堕浣镐缓缂備礁顑嗙€笛囨倵椤掑嫭鈷戦柣鐔告緲閳锋梻绱掗鍛仸鐎规洘鍨块獮鍥偋閸垹骞樼紓浣哄亾濠㈡ê鐣烽浣规珷缂備焦眉缁诲棝鏌ょ喊鍗炲闁告ê鐡ㄩ幈銊︾節閸曨厼绗￠梺鐟板槻閹虫ê鐣烽妸锔剧瘈闁告劑鍔屾竟宥囩磽閸屾艾鈧绮堟笟鈧、鏍礋椤撶噥鍋ㄥ┑顔斤供閸撴盯寮抽敃鍌涚厪闊洢鍎崇壕鎸庛亜閳哄啫鍘撮柟顔筋殜閺佹劖鎯斿┑鍫熸櫦闂備焦瀵х粙鎺楁儎椤栨凹娼栭柧蹇氼潐瀹曞鏌曟繛鍨姕闁诲繋鐒︾换婵嗏枔閸喗鐏撻梺杞扮椤兘鐛崘顔筋€愮紓浣哄У閻╊垶鐛▎鎾崇妞ゅ繐瀚弳鈺呮⒒娴ｈ棄鍚瑰┑顔藉劤閳诲秹鏁愭径濠勶紵闂侀潧鐗嗛敍鍡樺緞閹邦厼鈧兘鎮楅棃娑欐喐妞ゆ梹娲熷娲川婵犱胶绻侀梺鍛娒肩划娆忕暦閻㈢ǹ鐐婃い鎺嶈兌閸樻悂鎮楅崗澶婁壕闁诲函缍嗛崜娑溾叺濠碉紕鍋戦崐鎴﹀垂濞差亝鏅濋柕蹇嬪€曠粻鏍煏閸繃顥炲┑顖涙尦閺屾盯鏁傜拠鎻掔濠电姰鍨虹敮鈥愁潖婵犳艾纾兼繛鍡樺焾濡差噣姊洪崷顓涙嫛闁稿妫濋獮鍐敋閳ь剟銆侀弴銏℃櫇闁逞屽墰缁牊寰勯幇顓犲幍闁哄鐗嗘晶浠嬫偩鏉堚晝纾奸柣妯虹－婢х敻鏌＄仦鐐鐎规洜鍘ч埞鎴﹀箛椤撳濡囩槐鎺楁倷椤掆偓閸斻倝鏌涘顒夊剳闁瑰箍鍨归埥澶愬閻樻鍚呴梻浣虹帛閸ㄩ潧煤閿濆洦顐介柛顭戝亞缁犻箖鎮楅崹顐ｅ仩闁逞屽墮椤戝鐛箛娑欐櫢闁跨噦鎷� 
		}
		else {
			sprintf(buff_temp, "$%d;", (int)round(rudder));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鐐劤缂嶅﹪寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閹冣挃闁硅櫕鎹囬垾鏃堝礃椤忎礁浜鹃柨婵嗙凹缁ㄥジ鏌熼惂鍝ョМ闁哄矉缍侀、姗€鎮欓幖顓燁棧闂備線娼уΛ娆戞暜閹烘缍栨繝闈涱儐閺呮煡鏌涘☉鍗炲妞ゃ儲鑹鹃埞鎴炲箠闁稿﹥顨嗛幈銊╂倻閽樺锛涘┑鐐村灍閹崇偤宕堕浣镐缓缂備礁顑嗙€笛囨倵椤掑嫭鈷戦柣鐔告緲閳锋梻绱掗鍛仸鐎规洘鍨块獮鍥偋閸垹骞樼紓浣哄亾濠㈡ê鐣烽浣规珷缂備焦眉缁诲棝鏌ょ喊鍗炲闁告ê鐡ㄩ幈銊︾節閸曨厼绗￠梺鐟板槻閹虫ê鐣烽妸锔剧瘈闁告劑鍔屾竟宥囩磽閸屾艾鈧绮堟笟鈧、鏍礋椤撶噥鍋ㄥ┑顔斤供閸撴盯寮抽敃鍌涚厪闊洢鍎崇壕鎸庛亜閳哄啫鍘撮柟顔筋殜閺佹劖鎯斿┑鍫熸櫦闂備焦瀵х粙鎺楁儎椤栨凹娼栭柧蹇氼潐瀹曞鏌曟繛鍨姕闁诲繋鐒︾换婵嗏枔閸喗鐏撻梺杞扮椤兘鐛崘顔筋€愮紓浣哄У閻╊垶鐛▎鎾崇妞ゅ繐瀚弳鈺呮⒒娴ｈ棄鍚瑰┑顔藉劤閳诲秹鏁愭径濠勶紵闂侀潧鐗嗛敍鍡樺緞閹邦厼鈧兘鎮楅棃娑欐喐妞ゆ梹娲熷娲川婵犱胶绻侀梺鍛娒肩划娆忕暦閻㈢ǹ鐐婃い鎺嶈兌閸樻悂鎮楅崗澶婁壕闁诲函缍嗛崜娑溾叺濠碉紕鍋戦崐鎴﹀垂濞差亝鏅濋柕蹇嬪€曠粻鏍煏閸繃顥炲┑顖涙尦閺屾盯鏁傜拠鎻掔濠电姰鍨虹敮鈥愁潖婵犳艾纾兼繛鍡樺焾濡差噣姊洪崷顓涙嫛闁稿妫濋獮鍐敋閳ь剟銆侀弴銏℃櫇闁逞屽墰缁牊寰勯幇顓犲幍闁哄鐗嗘晶浠嬫偩鏉堚晝纾奸柣妯虹－婢х敻鏌＄仦鐐鐎规洜鍘ч埞鎴﹀箛椤撳濡囩槐鎺楁倷椤掆偓閸斻倝鏌涘顒夊剳闁瑰箍鍨归埥澶愬閻樻鍚呴梻浣虹帛閸ㄩ潧煤閿濆洦顐介柛顭戝亞缁犻箖鎮楅崹顐ｅ仩闁逞屽墮椤戝鐛箛娑欐櫢闁跨噦鎷� 
		}
		write(fd[1], buff_temp, strlen(buff_temp));
		printf("rudder %s\n", buff_temp);
}

//闂傚倸鍊搁崐鎼佸磹閹间礁纾圭€瑰嫭鍣磋ぐ鎺戠倞妞ゆ帒锕︾粙蹇旂節閵忥絾纭炬い鎴濇喘閵嗗懘骞撻幑妤€缍婇幃鈺侇啅椤旂厧澹堢紓鍌欒閸嬫挸顭块懜闈涘闁告瑦鎹囬弻娑㈠Ψ閿濆懎顬夌紓浣插亾闁告劦浜栭崑鎾舵喆閸曨剛顦ラ悗娈垮枛閻栧ジ鐛崼銉ノ╅柕澶樺枟鐎靛矂鏌ｉ悩鍙夌┛鐎殿喗鎸荤粩鐔煎即閵忥紕鍘介柟鍏肩暘閸娿倕顭囬幇顓犵闁告瑥锛冮幋鐘冲床婵炴垶鐟х弧鈧梺鎼炲劀閸曨厸鍋撻鍕拺闁荤喐婢橀埛鏃傜磼椤曞懎鐏︾€殿喗鐓￠獮鏍ㄦ媴閸︻厼寮抽梻浣虹帛濞叉牠宕愰崷顓涘亾濮樼偓瀚�
void pwm_thrust(double volt){
	memset(buff_temp, 0, sizeof(buff_temp));
    sprintf(buff_temp, "$%.1f;", volt);
	printf("thrust %s\n", buff_temp);
    write(fd[5], buff_temp, strlen(buff_temp));
}

//AD闂傚倸鍊搁崐鐑芥倿閿曚降浜归柛鎰电厑濞差亝鏅濋柛灞剧☉娴滈亶姊洪崨濠庢畼闁稿⿵缍侀幃銏ゆ偂鎼达絼绱滈梻浣瑰劤濞存岸宕戦崟顒傤浄闁跨噦鎷�
void AD_sample(int fd_index) 
{	
	char *filedata;
	switch (select(maxfd[fd_index] + 1, &rd[fd_index], NULL, NULL, NULL))     
	{
	case -1: perror("select:");
		break;
	case 0:
		perror("AD:read_0\n");
		break;
	default:
		if (FD_ISSET(fd[fd_index], &rd[fd_index]))
		{
			int temp;
			memset(buff_AD, 0,  sizeof(buff_AD));
			if ((temp=read(fd[fd_index], buff_AD, sizeof(buff_AD))) < 0)
				perror("AD:read_fail");
			else
			{
				//printf("buff_AD = %s\n",buff_AD);
				buff_AD[temp] = '\0';

				if ((filedata = strstr(buff_AD, ">")) != NULL)
				{
					if (((filedata[1] == '+') || (filedata[1] == '-'))        
						&& ((filedata[8] == '+') || (filedata[8] == '-'))
						&& ((filedata[15] == '+') || (filedata[15] == '-'))
						&& ((filedata[22] == '+') || (filedata[22] == '-'))
						&& ((filedata[29] == '+') || (filedata[29] == '-'))
						&& ((filedata[36] == '+') || (filedata[36] == '-'))
						&& ((filedata[43] == '+') || (filedata[43] == '-'))
						&& ((filedata[50] == '+') || (filedata[50] == '-')))
					{	
						pthread_mutex_lock(&AD_DATA.mutex); 
						strncpy(buff_temp, filedata + 43, 7);
						buff_temp[7] = '\0';
						AD_DATA.vol = strtod(buff_temp, NULL);

						strncpy(buff_temp, filedata + 22, 7);
						buff_temp[7] = '\0';
						tcflush(fd[fd_index], TCIFLUSH);	
						AD_DATA.rudder =-(-120.29644- (strtod(buff_temp, NULL)) / 0.0185)-274.902;
						pthread_mutex_unlock(&AD_DATA.mutex); 
					}
				}
				else { printf("filedata information error!!!");
								tcflush(fd[fd_index], TCIFLUSH); }
				return;
			}		
			}
		}

	}


void*  AD_thread() {
        while(1){
		AD_sample(6);
        usleep(50000); // 缂傚倸鍊搁崐鐑芥倿閿斿墽鐭欓柟娆¤娲、娑樷堪閸曢潧浠洪梻浣芥硶閸ｏ箓骞忛敓锟�50婵犵數濮甸鏍闯椤栨粎绀婇柛鈩冪☉绾惧鏌涢埄鍐ㄥ枙缂傚秵鐗犻弻銊╂偆閸屾稑顏�,闂傚倸鍊风粈渚€骞夐敓鐘茬闁哄洨濮烽惌鎾绘煟閵忕姴顥忛柡浣稿暣閺屻倕霉鐎ｎ偅鐝掗梺缁樺笒閿曘儳鎹㈠┑瀣棃婵炴垵鍟挎慨娑樷攽閳ュ啿绾ч柟顔煎€搁～蹇撁洪鍕唽闂佸湱鍎ら幐鎼佀囬埡鍛拺缂備焦锕╁▓锝夋煙閸戙倖瀚�
        }
}