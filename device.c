#include "./device.h"

struct timeval tv = { 0,1000};	//0.01s 闂備浇宕垫慨鏉懨洪埡鍜佹晪鐟滄垿濡甸幇鐗堟櫢闁跨噦鎷�
AD_data AD_DATA = {
    .rudder = 0.0,
    .vol = 0.0,
    .mutex = PTHREAD_MUTEX_INITIALIZER  // 闂傚倸鍊搁崐鎼佹偋婵犲洦鍋￠柨鏇炲€搁悞鍨亜閹达絾纭舵い锔肩畵閺屾盯濡搁妷褌绮甸梺閫涚┒閸斿酣鍩€椤掑﹦绉靛ù婊勭矒椤㈡俺顦规慨濠勫劋瀵板嫰宕妷褏鎽岀紓鍌欐祰妞存悂鎮烽敃鍌椻偓鏃堝焵椤掍椒绻嗘い鏍ㄤ緱閸庛儵鏌涘顒佸枠闁哄矉绻濆畷濂割敃閿熺姴浠愰梻浣姐€€閸嬫捇鏌ㄥ┑鍡樼闁稿鎸鹃幉鎾礋椤撶偞娈圭紓鍌欑劍閸炲骞忛敓锟�
};

//闂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾妤犵偞鐗犻、鏇㈡晝閳ь剛澹曢崷顓犵＜閻庯綆鍋撶槐鈺傜箾瀹割喕绨奸柡鍛叀閺屾稑鈽夐崣妯煎嚬闂佽楠搁…宄邦潖濞差亝顥堟繛鎴炴皑閻ゅ嫰姊虹粙鍖℃敾婵炲弶绮庨崚鎺撶節濮橆厼浠洪梺鍛婄缚閸庤精銇愰崟顖涒拺闁硅偐鍋涢崝姗€鏌涢弬璺ㄧ缂佹梻鍠庨～婊堝焵椤掑嫬钃熼柨婵嗘啒閺冣偓閹峰懘宕烽鐕佸悋缂傚倸鍊峰ù鍥ㄣ仈閸濄儲鏆滈柟鐑樻礈娴滄瑩姊虹拠鎻掑毐缂傚秴妫濆畷婊冣槈閵忕姵杈堥梺缁橆焽缁垶鍩涢幋锔界厵闁兼祴鏅涙禒婊冣攽閳ョ偨鍋㈤柡宀嬬秬缁犳盯寮崹顔芥嚈婵°倗濮烽崑娑㈡偋閹剧繝绻嗘慨婵嗙焾濡茬兘姊虹粙娆惧剱闁圭懓娲顐﹀箛椤撶喎鍔呭┑鐘绘涧閻楀繐鈻旈幐搴濈箚闁绘劦浜滈埀顒佺墪鐓ら柍鍝勬噹缁狀垶鏌ㄩ悤鍌涘
void fd_initialize(){
	//闂傚倸鍊搁崐鎼佸磹閻戣姤鍤勯柤鍝ユ暩娴犳岸姊洪懡銈呬沪闁告垵缍婂畷鎴炵節閸屾粍娈惧┑鐘绘涧濡盯寮抽崱娑欑厱闁哄洢鍔屾晶顔济归悩璁虫喚婵﹥妞藉Λ鍐归妷銉уⅵ鐎殿喗褰冮埥澶娢熷⿰鍕槈妞ゎ偅绮撻崺鈧い鎺戝閽冪喐绻涢幋娆忕仼閸烆垰顪冮妶鍡欏⒈闁稿鍋ら、鎾愁吋閸滀焦瀵岄梺闈涚墕濡鎱ㄨ閺岀喖宕欓妶鍡楊伓
	file_data = fopen("data/output.csv", "a");
    if (file_data== NULL) {
        perror("Failed to open file");
        return; 
    }
   	fprintf(file_data, "\xEF\xBB\xBF");  // UTF-8 BOM
    fprintf(file_data, "闂傚倷绀侀幖顐﹀疮椤愶附鍋夐柣鎾冲濞戙垹閿ゆ俊銈傚亾缂佺媴缍侀弻銊╂偆閸屾稑顏�,闂傚倷娴囧銊╂倿閿曗偓椤灝顫滈埀顒勫箖妤︽妯勯悗娈垮枙缁瑥鐣烽崼鏇炵厸濠电姴鍊歌ⅷ,缂傚倸鍊搁崐椋庣矆娴ｇ儤宕查柟閭﹀枓閸嬫捇鎯傞崨濠傤伓,缂傚倸鍊烽懗鍫曟惞鎼淬劌绀堟繛鍡樺灍閸嬫捇鎯傞崨濠傤伓,闂傚倷娴囬崑鎰板箠閹捐埖宕查柟鐗堟緲缁犳牠鏌ㄩ悤鍌涘,闂備浇宕甸崰鎰版偡閿旂偓鏆滈柨鐔哄Т閻掑灚銇勯幒鎴濃偓鎼佸几鎼淬劍鍊甸柣褍鎲＄€氾拷,x闂傚倷鑳堕～瀣礋椤愩埄娼旈梻浣虹帛閻楊參骞忛敓锟�,闂傚倷绀侀幉锛勫枈瀹ュ鍨傞柣銏㈩暯閸嬫捇宕归鈶╂灆闂佸搫鑻幊姗€骞冮姀鐘垫殝闂侇叏绠戦弫锟�,y闂傚倷鑳堕～瀣礋椤愩埄娼旈梻浣虹帛閻楊參骞忛敓锟�,闂傚倷绀侀幉锛勫枈瀹ュ鍨傜€规洖娲ㄧ粻鏃堟煏韫囧鈧牠鎮炴繝姘厽闁哄倸鐏濆Σ缁樸亜閺冩挻瀚�,闂傚倷绀侀幖顐︽偋韫囨稑绐楅柟閭﹀墾閼版寧绻濇繝鍌滃闁搞倕鐭傞悡顐﹀炊閵婏箑闉嶉梺绋库康閹凤拷,闂傚倷绀侀幖顐︽偋韫囨稑绐楅柟閭﹀墾閼版寧绻濇繝鍌滃闁绘帒顭烽弻锝夊棘閸喗些濡炪倖妫戦幏锟�,闂傚倷绀侀幖顐︽偋韫囨稑绐楅柟閭﹀墾閼版寧绻濇繝鍌涘櫤闁哥姴妫濋弻鐔兼倻濡晲绮堕梺绋款儐閹瑰洭骞冮姀鐘垫殝闂侇叏绠戦弫锟�,闂傚倷绀侀幖顐︽偋韫囨稑绐楅柟閭﹀墾閼版寧绻濇繝鍌滃闁搞倕顑呴湁闁挎繂鎳庨弸銈嗙箾绾攱瀚�,闂傚倷绀侀幖顐︽偋韫囨稑绐楅柟閭﹀墾閼版寧绻濇繝鍌滃缂佺姵濞婇弻鏇熺箾閸喖顬嬬紓浣哄Т椤兘寮诲☉銏℃櫜闁告劑鍔岄‖瀣⒑鏉炴壆鍔嶉柟顔煎€搁悾鐑藉閵堝棙娅㈤梺璺ㄥ櫐閹凤拷,闂傚倷绀侀妶鎼佸疾閼碱剙绶ゅ┑鐘崇啲缂嶆牗淇婇妶鍛殶闁活厽鎸婚妵鍕冀閵娿劌顥濋梺璇查椤兘骞冪捄琛℃闁哄诞鍐潛濠电偛顕妴瀣箯閿燂拷,闂傚倷鑳堕崢褎绔熸繝鍐洸妞ゅ繐鐗嗛悞鍨亜閹烘埊鏀婚悗姘炬嫹,闂備浇顕ф绋匡耿闁秴纾婚柕鍫濇媼閻庤埖銇勯弽顐沪闁搞倕顑呴湁闁挎繂鎳庨弸銈嗙箾绾攱瀚�,闂備浇顕ф绋匡耿闁秴纾婚柕鍫濇媼閻庤埖銇勯弽顐粶缂佺姵濞婇弻鏇熺箾閸喖顬嬬紓浣哄Т椤兘寮诲☉銏℃櫜闁告劑鍔岄‖瀣⒑鏉炴壆鍔嶉柟顔煎€搁悾鐑藉閵堝棙娅㈤梺璺ㄥ櫐閹凤拷,闂傚倷娴囬崑鎰板箠閹捐泛鍨濈紒瀣舵嫹1,闂傚倷娴囬崑鎰板箠閹捐泛鍨濈紒瀣舵嫹2,闂傚倷娴囬崑鎰板箠閹捐泛鍨濈紒瀣舵嫹3,闂備浇宕甸崰鎰版偡閿旇姤娅犵紓宥忔嫹1,闂備浇宕甸崰鎰版偡閿旇姤娅犵紓宥忔嫹2,闂備浇宕甸崰鎰版偡閿旇姤娅犵紓宥忔嫹3,闂傚倸鍊风欢锟犲磻閸℃稑绀傞悗娑虫嫹1,闂傚倸鍊风欢锟犲磻閸℃稑绀傞悗娑虫嫹2,闂傚倸鍊风欢锟犲磻閸℃稑绀傞悗娑虫嫹3\n");
	if ((fd[0] = open_port(fd[0], 12)) < 0) { 
		perror("open_port error...tmt");
		return;
	}

	if ((fd_i[0] = set_opt(fd[0], 19200, 8, 'N', 1)) < 0) {
		perror("set_opt error...tmt");
		return;
	}
	if ((fd[1] = open_port(fd[1], 7)) < 0) {
		perror("open_port error...rudder");
		return;
	}
	if ((fd_i[1] = set_opt(fd[1], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...rudder");
		return;
	}

	if ((fd_NV = open_port(fd_NV, 4)) < 0) {
		perror("open_port error...NV");
		return;
	}
	if ((fd_i_NV= set_opt(fd_NV, 115200, 8, 'N', 1)) < 0) {
		perror("set_opt error...NV");
		return;
	}

	if ((fd[5] = open_port(fd[5], 5)) < 0) {  //闂傚倷娴囬～澶嬬娴犲绀夐煫鍥ㄦ礃瀹曞弶鎱ㄥ璇蹭壕閻庤娲樻繛濠囧极閹剧粯鏅搁柨鐕傛嫹
		perror("open_port error...thrust");
		return;
	}
	if ((fd_i[5] = set_opt(fd[5], 9600, 8, 'N', 1)) < 0) {// 闂傚倷娴囬～澶嬬娴犲绀夐煫鍥ㄦ礃瀹曞弶鎱ㄥ璇蹭壕閻庤娲樻繛濠囧极閹剧粯鏅搁柨鐕傛嫹
		perror("set_opt error...thrust");
		return;
	}
	if ((fd[6] = open_port(fd[6], 1)) < 0) {   //AD
		perror("open_port error...AD");
		return;
	}
	if ((fd_i[6] = set_opt(fd[6], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...AD");
		return;
	}
	printf("port has been open\n");


	int i;
    for ( i = 0; i < FD_NUM; i++) {
        FD_ZERO(&rd[i]);            
	    FD_SET(fd[i], &rd[i]);      
	    maxfd[i] = fd[i];           
    }
	
	FD_SET(fd_NV, &rd_NV);
	maxfd_NV = fd_NV;
}


void fd_cleanup() {
    int i;
    
    // Close all file descriptors in fd array
    for (i = 0; i < FD_NUM; i++) {
        if (fd[i] >= 0) {
            close(fd[i]);
            fd[i] = -1;
        }
    }
    
    // Close NV file descriptor
    if (fd_NV >= 0) {
        close(fd_NV);
        fd_NV = -1;
    }
    
    // Close the data file
    if (file_data != NULL) {
        fclose(file_data);
        file_data = NULL;
    }
    
    // Clear all file descriptor sets
    for (i = 0; i < FD_NUM; i++) {
        FD_ZERO(&rd[i]);
        maxfd[i] = -1;
    }
    
    FD_ZERO(&rd_NV);
    maxfd_NV = -1;
    
    printf("file descriptor has been cleaned");
}
//闂傚倸鍊搁崐鎼佸磹瀹勬噴褰掑炊椤掆偓绾惧鏌熼柇锕€骞樺ù鐘冲哺濮婄粯鎷呯粵瀣缂備胶绮崹鍧楀箠濠靛洢鍋呴柛鎰╁妿閸樻挳姊洪崨濠傚Е闁哥姵鐗犻幃鐐烘偨閸涘﹦鍙嗛梺缁樻礀閸婂湱鈧熬鎷�
void pwm_rudder(double rudder){
		memset(buff_temp, 0, sizeof(buff_temp));//濠电姷鏁告慨鐑藉极閸涘﹥鍙忛柣鎴ｆ閺嬩線鏌涘☉姗堟敾闁告瑥绻橀弻锝夊箣閿濆棭妫勯梺鍝勵儎缁舵岸寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閻愵剙鍔ゆい顓犲厴瀵鏁愭径濠勭杸濡炪倖甯婇悞锕傚磿閹惧墎纾藉ù锝呮惈灏忛梺鍛婎殕婵炲﹤顕ｆ繝姘亜闁稿繐鐨烽幏濠氭煟鎼淬劍娑у鐟帮工鍗辨い鏂垮⒔绾捐棄霉閿濆懏鎯堥崯鍛婄節閻㈤潧浜归柛瀣崌濮婃椽宕崟顓犱紘闂佸摜濮甸悧鐘荤嵁閸愵収妯勯悗瑙勬礀閵堟悂骞冮姀銈呬紶闁告洦鍋呴濂告⒒閸屾艾鈧兘鎳楅崜浣稿灊妞ゆ牜鍋涚粻鏉库攽閻樺磭顣查柡鍛箞閺屾洝绠涚€ｎ亖鍋撻弴銏″珔闁绘柨鍚嬮悡鍐煏婢舵稓鐣卞褜鍨堕弻娑橆潩椤掑鍓跺Δ鐘靛仦閻楁粓宕氶幒妤€绀傚璺猴梗婢规洟姊洪懖鈹炬嫛闁告挻鐩畷鍝勵吋婢跺鎷婚梺绋挎湰閻熴劑宕楀畝鍕嚑妞ゅ繐鎳屾禍婊堟煙鐎涙绠栨い銉ｅ灪椤ㄣ儵鎮欓弶鎴濐潚濡ょ姷鍋為悧妤呭箯閸涙潙浼犻柕澶堝劚缂佲晜绻濋悽闈浶為柛銊у帶閳绘柨鈽夊⿰鍐炬澓闂傚倷绀侀幖顐︻敄閸涱垪鍋撳☉鎺撴珕缂佸矁椴哥换婵嬪炊閼稿灚娅栨繝鐢靛█濞佳兾涘Δ鍛畾闁绘劗鍎ら埛鎴︽煕濠靛棗顏柨娑樼Ч閺屾稑螣閸啩鎾剁磼瀹€鍐摵缂佺粯绻堝畷鍫曞Ω閵夈垹浜鹃梺鍨儍娴滄粓鐓崶銊﹀碍妞ゅ繈鍊濋弻娑氣偓锝庡亝瀹曞瞼鈧鍠曠划娆撱€佸鈧幃娆戔偓娑欘焺濮橆兘鏀介柣妯虹仛閺嗏晛鈹戦鑺ョ稇閻撱倝鏌曢崼婵囧窛濞戞挸绉甸妵鍕冀椤愵澀娌梺缁樻尪閸庣敻寮婚敐澶婂嵆闁绘劖绁撮崑鎾诲捶椤撴稑浜炬慨妯煎亾鐎氾拷
		rudder=rudder-5;
		// if (fabs(CTRL_DATA_PSI.yd_1[0]-CTRL_DATA_PSI.y_1[0])<=10){
		// 		rudder*=0.7;
		// }
		rudder = -rudder;
		if ((rudder < 10) && (rudder >= 0))
		{
			sprintf(buff_temp, "$0%d;", (int)round(fabs(rudder)));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鎯у⒔閹虫捇鈥旈崘顏佸亾閿濆簼绨奸柟鐧哥秮閺岋綁顢橀悙鎼闂侀潧妫欑敮鎺楋綖濠靛鏅查柛娑卞墮椤ユ艾鈹戞幊閸婃鎱ㄩ悜钘夌；婵炴垟鎳為崶顒佸仺缂佸瀵ч悗顒勬⒑閻熸澘鈷旂紒顕呭灦瀹曟垿骞囬悧鍫㈠幘缂佺偓婢樺畷顒佹櫠缂佹ü绻嗛柤纰卞墮閸樺瓨鎱ㄦ繝鍕笡闁瑰嘲鎳樺畷銊︾節閸愩劌澹嶇紓鍌氬€风粈渚€顢栭崟顓燁偨婵﹩鍓涢弳锕傛煏韫囥儳纾挎い鈺冨厴閹鏁愭惔婵堟晼闂佹寧绋掗惄顖氼潖閾忚宕夐柕濞垮劜閻忎焦绻濆▓鍨灓闁轰礁顭烽獮鍐缂佺姵鐩獮娆撳礃椤忓嫭鏆╅梻浣藉吹婵儳鈻嶉敐澶婄？闁靛牆锛嗘径鎰€烽悗闈涙憸椤旀洟姊洪崨濠佺繁闁告ü绮欏畷鐢稿炊椤掍胶鍘搁悗鍏夊亾閻庯綆鍓涜ⅵ婵＄偑鍊戦崹娲晝閵忋倕绠栭柕鍫濇婵挳鏌涢敂璇插箺婵犮垺甯″濠氬磼濞嗘埈妲梺鍦拡閸嬪棝骞冮鈧、鏇㈡晝閳ь剛绮堟径鎰厵閺夊牆澧介悾杈╃磼閻樺磭澧甸柡灞炬礋瀹曠厧鈹戦幇顓夛妇绱掗悙顒€鍔ら柛姘儑閹广垹鈽夐姀鐘殿吅闂佺粯鍨靛ú锝囨閸偆绠鹃悗鍨偠閳ь剙顑夐獮蹇涙晸閿燂拷 
		}
		else if ((rudder< 0) && (rudder> -10))
		{

			sprintf(buff_temp, "$-0%d;", (int)round(fabs(rudder)));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鎯у⒔閹虫捇鈥旈崘顏佸亾閿濆簼绨奸柟鐧哥秮閺岋綁顢橀悙鎼闂侀潧妫欑敮鎺楋綖濠靛鏅查柛娑卞墮椤ユ艾鈹戞幊閸婃鎱ㄩ悜钘夌；婵炴垟鎳為崶顒佸仺缂佸瀵ч悗顒勬⒑閻熸澘鈷旂紒顕呭灦瀹曟垿骞囬悧鍫㈠幘缂佺偓婢樺畷顒佹櫠缂佹ü绻嗛柤纰卞墮閸樺瓨鎱ㄦ繝鍕笡闁瑰嘲鎳樺畷銊︾節閸愩劌澹嶇紓鍌氬€风粈渚€顢栭崟顓燁偨婵﹩鍓涢弳锕傛煏韫囥儳纾挎い鈺冨厴閹鏁愭惔婵堟晼闂佹寧绋掗惄顖氼潖閾忚宕夐柕濞垮劜閻忎焦绻濆▓鍨灓闁轰礁顭烽獮鍐缂佺姵鐩獮娆撳礃椤忓嫭鏆╅梻浣藉吹婵儳鈻嶉敐澶婄？闁靛牆锛嗘径鎰€烽悗闈涙憸椤旀洟姊洪崨濠佺繁闁告ü绮欏畷鐢稿炊椤掍胶鍘搁悗鍏夊亾閻庯綆鍓涜ⅵ婵＄偑鍊戦崹娲晝閵忋倕绠栭柕鍫濇婵挳鏌涢敂璇插箺婵犮垺甯″濠氬磼濞嗘埈妲梺鍦拡閸嬪棝骞冮鈧、鏇㈡晝閳ь剛绮堟径鎰厵閺夊牆澧介悾杈╃磼閻樺磭澧甸柡灞炬礋瀹曠厧鈹戦幇顓夛妇绱掗悙顒€鍔ら柛姘儑閹广垹鈽夐姀鐘殿吅闂佺粯鍨靛ú锝囨閸偆绠鹃悗鍨偠閳ь剙顑夐獮蹇涙晸閿燂拷 
		}
		else {
			sprintf(buff_temp, "$%d;", (int)round(rudder));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鎯у⒔閹虫捇鈥旈崘顏佸亾閿濆簼绨奸柟鐧哥秮閺岋綁顢橀悙鎼闂侀潧妫欑敮鎺楋綖濠靛鏅查柛娑卞墮椤ユ艾鈹戞幊閸婃鎱ㄩ悜钘夌；婵炴垟鎳為崶顒佸仺缂佸瀵ч悗顒勬⒑閻熸澘鈷旂紒顕呭灦瀹曟垿骞囬悧鍫㈠幘缂佺偓婢樺畷顒佹櫠缂佹ü绻嗛柤纰卞墮閸樺瓨鎱ㄦ繝鍕笡闁瑰嘲鎳樺畷銊︾節閸愩劌澹嶇紓鍌氬€风粈渚€顢栭崟顓燁偨婵﹩鍓涢弳锕傛煏韫囥儳纾挎い鈺冨厴閹鏁愭惔婵堟晼闂佹寧绋掗惄顖氼潖閾忚宕夐柕濞垮劜閻忎焦绻濆▓鍨灓闁轰礁顭烽獮鍐缂佺姵鐩獮娆撳礃椤忓嫭鏆╅梻浣藉吹婵儳鈻嶉敐澶婄？闁靛牆锛嗘径鎰€烽悗闈涙憸椤旀洟姊洪崨濠佺繁闁告ü绮欏畷鐢稿炊椤掍胶鍘搁悗鍏夊亾閻庯綆鍓涜ⅵ婵＄偑鍊戦崹娲晝閵忋倕绠栭柕鍫濇婵挳鏌涢敂璇插箺婵犮垺甯″濠氬磼濞嗘埈妲梺鍦拡閸嬪棝骞冮鈧、鏇㈡晝閳ь剛绮堟径鎰厵閺夊牆澧介悾杈╃磼閻樺磭澧甸柡灞炬礋瀹曠厧鈹戦幇顓夛妇绱掗悙顒€鍔ら柛姘儑閹广垹鈽夐姀鐘殿吅闂佺粯鍨靛ú锝囨閸偆绠鹃悗鍨偠閳ь剙顑夐獮蹇涙晸閿燂拷 
		}
		write(fd[1], buff_temp, strlen(buff_temp));
		printf("rudder %s\n", buff_temp);
}

//闂傚倸鍊搁崐鎼佸磹瀹勬噴褰掑炊椤掑﹦绋忔繝銏ｆ硾椤戝洭銆呴幓鎹楀綊鎮╁顔煎壈缂備讲鍋撳鑸靛姉閸欐捇鏌涢妷锝呭缂佲偓閸愵亖鍋撶憴鍕鐎殿喖鐖奸獮鍫ュΩ閵夘喗瀵岄柣鐘叉穿瀵挻绔熼弴銏＄厽閹兼番鍊ゅ鎰箾閸欏＃鎴犳崲濞戞瑧绡€闁搞儜鍕偓顒勬⒑閻熸澘鈷旂紒顕呭灦瀵煡骞栨担鍦弳闂佺粯娲栭崐鍦偓姘炬嫹
void pwm_thrust(double volt){
	memset(buff_temp, 0, sizeof(buff_temp));
    sprintf(buff_temp, "$%.1f;", volt);
	printf("thrust %s\n", buff_temp);
    write(fd[5], buff_temp, strlen(buff_temp));
}

//AD闂傚倸鍊烽悞锕併亹閸愵煁娲晝閸屾稑浜遍梺鍛婎殘閸婏綁鎮㈤悡搴ｄ紜闂佹儳娴氶崑鍕閿燂拷
void AD_sample(int fd_index) 
{	
	char *filedata;
	switch (select(maxfd[fd_index] + 1, &rd[fd_index], NULL, NULL, NULL))     
	{
	case -1: perror("select:");
		break;
	case 0:
		perror("AD:read_0\n");
		break;
	default:
		if (FD_ISSET(fd[fd_index], &rd[fd_index]))
		{
			int temp;
			memset(buff_AD, 0,  sizeof(buff_AD));
			if ((temp=read(fd[fd_index], buff_AD, sizeof(buff_AD))) < 0)
				perror("AD:read_fail");
			else
			{
				//printf("buff_AD = %s\n",buff_AD);
				buff_AD[temp] = '\0';

				if ((filedata = strstr(buff_AD, ">")) != NULL)
				{
					if (((filedata[1] == '+') || (filedata[1] == '-'))        
						&& ((filedata[8] == '+') || (filedata[8] == '-'))
						&& ((filedata[15] == '+') || (filedata[15] == '-'))
						&& ((filedata[22] == '+') || (filedata[22] == '-'))
						&& ((filedata[29] == '+') || (filedata[29] == '-'))
						&& ((filedata[36] == '+') || (filedata[36] == '-'))
						&& ((filedata[43] == '+') || (filedata[43] == '-'))
						&& ((filedata[50] == '+') || (filedata[50] == '-')))
					{	
						pthread_mutex_lock(&AD_DATA.mutex); 
						strncpy(buff_temp, filedata + 43, 7);
						buff_temp[7] = '\0';
						AD_DATA.vol = strtod(buff_temp, NULL);

						strncpy(buff_temp, filedata + 22, 7);
						buff_temp[7] = '\0';
						tcflush(fd[fd_index], TCIFLUSH);	
						AD_DATA.rudder =-(-120.29644- (strtod(buff_temp, NULL)) / 0.0185)-274.902;
						pthread_mutex_unlock(&AD_DATA.mutex); 
					}
				}
				else { printf("filedata information error!!!");
								tcflush(fd[fd_index], TCIFLUSH); }
				return;
			}		
			}
		}

	}


void*  AD_thread() {
        while(1){
		AD_sample(6);
        usleep(50000); // 缂傚倸鍊烽悞锔剧矙閹次诲洭顢涘⿰鍕靛仺闂佽法鍣﹂幏锟�50濠电姵顔栭崳顖滅礊閸℃稑纾婚柛鈩冨喕缂嶆牠鏌ㄩ悤鍌涘,闂傚倷绀侀幉锟犲礉閺囩姷鐭撻柣銏犲閺佸啴鏌ゅù瀣珒闁绘帒锕ョ换婵嬫濞戝啿濮涘┑鈥冲级閹倸顫忓ú顏勭闁圭儤鎸搁ˇ鈺呮⒑缂佹﹩娈ｉ柟鍑ゆ嫹
        }
}