#include "./device.h"

struct timeval tv = { 0,1000};	
AD_data AD_DATA = {
    .rudder = 0.0,
    .vol = 0.0,
    .mutex = PTHREAD_MUTEX_INITIALIZER  
};


void fd_initialize(){
	
	file_data = fopen("data/output.csv", "a");
    if (file_data== NULL) {
        perror("Failed to open file");
        return; 
    }
    fprintf(file_data, "\xEF\xBB\xBF");  // UTF-8 BOM
    fprintf(file_data, "时间戳,数字标签,经度,纬度,艏向,角速度,x坐标,向北速度,y坐标,向东速度,期望艏向,期望速度,期望角速度,期望舵角,期望推进器电压,舵角积分补偿,航速,实际舵角,实际推进器电压,艏PG1,艏PG2,艏PG3,角PG1,角PG2,角PG3,速PG1,速PG2,速PG3\n");
	if ((fd[0] = open_port(fd[0], 12)) < 0) { 
		perror("open_port error...tmt");
		return;
	}

	if ((fd_i[0] = set_opt(fd[0], 19200, 8, 'N', 1)) < 0) {
		perror("set_opt error...tmt");
		return;
	}
	if ((fd[1] = open_port(fd[1], 7)) < 0) {
		perror("open_port error...rudder");
		return;
	}
	if ((fd_i[1] = set_opt(fd[1], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...rudder");
		return;
	}

	if ((fd_NV = open_port(fd_NV, 4)) < 0) {
		perror("open_port error...NV");
		return;
	}
	if ((fd_i_NV= set_opt(fd_NV, 115200, 8, 'N', 1)) < 0) {
		perror("set_opt error...NV");
		return;
	}

	if ((fd[5] = open_port(fd[5], 5)) < 0) {  
		perror("open_port error...thrust");
		return;
	}
	if ((fd_i[5] = set_opt(fd[5], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...thrust");
		return;
	}
	if ((fd[6] = open_port(fd[6], 1)) < 0) {   //AD
		perror("open_port error...AD");
		return;
	}
	if ((fd_i[6] = set_opt(fd[6], 9600, 8, 'N', 1)) < 0) {
		perror("set_opt error...AD");
		return;
	}
	printf("port has been open\n");


	int i;
    for ( i = 0; i < FD_NUM; i++) {
        FD_ZERO(&rd[i]);            
	    FD_SET(fd[i], &rd[i]);      
	    maxfd[i] = fd[i];           
    }
	
	FD_SET(fd_NV, &rd_NV);
	maxfd_NV = fd_NV;
}


void fd_cleanup() {
    int i;
    
    // Close all file descriptors in fd array
    for (i = 0; i < FD_NUM; i++) {
        if (fd[i] >= 0) {
            close(fd[i]);
            fd[i] = -1;
        }
    }
    
    // Close NV file descriptor
    if (fd_NV >= 0) {
        close(fd_NV);
        fd_NV = -1;
    }
    
    // Close the data file
    if (file_data != NULL) {
        fclose(file_data);
        file_data = NULL;
    }
    
    // Clear all file descriptor sets
    for (i = 0; i < FD_NUM; i++) {
        FD_ZERO(&rd[i]);
        maxfd[i] = -1;
    }
    
    FD_ZERO(&rd_NV);
    maxfd_NV = -1;
    
    printf("file descriptor has been cleaned");
}
//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳婀遍埀顒傛嚀鐎氼參宕崇壕瀣ㄤ汗闁圭儤鍨归崐鐐差渻閵堝棗鍧婇柛瀣尵閻ヮ亪骞嗚閻撳ジ鏌″畝鈧崰鏍蓟閸ヮ剚鏅濋柍褜鍓熼悰顔嘉熸總钘夌秺閹晠宕橀幓鎺撴嚈婵犳鍠栭敃锔惧垝椤栫偛绠柛娑卞灣妞规娊鎮楅敐搴濈凹妞ゆ柨瀚槐鎾诲磼濞嗘帒鍘＄紓渚囧櫘閸ㄨ泛鐣疯ぐ鎺戦敜婵°倐鍋撶紒鐘靛У缁绘繈妫冨☉娆忓亶闂佺ǹ顑呴幊姗€寮诲☉銏犵疀闁宠桨绀侀‖瀣⒑閸涘鎴﹀箰閸愬樊娼栨繛宸簻瀹告繂鈹戦悩鎻掆偓姝岊杺闂傚倷绀侀幗婊勬叏閻㈠憡鍋嬮柣妯款嚙缁犳牠鏌ｉ幇顔煎妺闁稿鍔戦弻娑樷槈濮楀牆濮涢梺鍛婄懃濡繂顫忛搹鍦＜婵☆垵宕甸ˇ銉╂⒑缁嬪尅宸ユ繝鈧柆宥呯劦妞ゆ帊鑳堕崯鏌ユ煙閸戙倖瀚�
void pwm_rudder(double rudder){
		memset(buff_temp, 0, sizeof(buff_temp));//婵犵數濮烽弫鍛婃叏閻戣棄鏋侀柛娑橈攻閸欏繘鏌ｉ幋锝嗩棄闁哄绶氶弻娑樷槈濮楀牊鏁鹃梺鍛婄懃缁绘﹢寮婚敐澶婄闁挎繂妫Λ鍕⒑閸濆嫷鍎庣紒鑸靛哺瀵鈽夊Ο閿嬵潔濠殿喗顨呴悧濠囧极妤ｅ啯鈷戦柛娑橈功閹冲啰绱掔紒姗堣€跨€殿喖顭烽弫鎰緞婵犲嫷鍚呴梻浣瑰缁诲倸螞椤撶倣娑㈠礋椤栨稈鎷洪梺鍛婄箓鐎氱兘宕曟惔锝囩＜闁兼悂娼ч崫铏光偓娈垮枛椤兘骞冮姀銈呯閻忓繑鐗楃€氫粙姊虹拠鏌ュ弰婵炰匠鍕彾濠电姴浼ｉ敐澶樻晩闁告挆鍜冪床闂備胶绮崝锕傚礈濞嗘挸绀夐柕鍫濇娴滄粍銇勯幘璺盒㈤柛妯侯嚟閳ь剚顔栭崰鏍€﹂悜钘夋瀬闁归偊鍘肩欢鐐测攽閻樻彃顏柡澶婃啞娣囧﹪鎮欓鍕ㄥ亾閺嶎偅鏆滃┑鐘叉处閸婂潡鏌ㄩ弴鐐测偓鍝ュ閸ф鐓欓柟顖嗗喚鏆㈢紒鐐礃濡嫰婀侀梺鎸庣箓閹冲繘骞嗛崼顫剨闊洦绋掗埛鎴︽煕濞戞ǚ鐪嬫繛鍫熸礀閳规垿鎮欑拠褍浼愬銈嗘穿缁插墽鎹㈠┑鍡╂僵妞ゆ挾鍋樼花濠氭⒒娴ｅ懙鍦崲閹扮増鍎嶉柣鎴ｆ缁狀垰鈹戦悩宕囶暡闁绘挾鍠栭獮鏍庨鈧俊鑺ョ箾閹冲嘲鍠氶悢鍡涙煟閻斿嘲绨荤€规悶鍎靛畷鈩冩綇閵婏絼绨婚梺鍝勫€搁悘婵嬪煕閺冨倻妫柟瑙勫姈椤ュ妫佹径鎰叆婵犻潧妫欓崳娲煙椤栨氨澧︾€规洦鍨跺畷銊︾節閸曨厾妲囬梻浣圭湽閸ㄨ棄顭囪缁傚秷銇愰幒鎾跺幈闁诲函缍嗛崑鍛暦鐏炵偓鍙忓┑鐘插暞閵囨繄鈧娲﹂崑濠傜暦閻旂⒈鏁囬柣妯夸含缁€鍐⒒閸屾瑧顦﹂柟鑺ョ矋閹便劑鎮介崨濠備罕闂佺粯枪瀹曢潧鐣垫笟鈧弻娑㈠箛闂堟稑瀛ｅ┑鈽嗗灠鐎氫即骞冨Δ鍐╁枂闁告洦鍓涢ˇ銉╂⒑闂堟稓澧涢柟顔煎€块悰顕€宕橀纰辨綂闂侀潧鐗嗛幊宥囨閸洘鈷戦柛娑橈攻婢跺嫰鏌涚€ｎ亝鍤囨い銏∩戠缓浠嬪川婵炵偓瀚介梻浣呵归張顒勬嚌妤ｅ啫鐒垫い鎺戝€搁崢鎾煙閾忣偒娈滅€规洘绮嶉幏鍛矙鐠恒劋鍠婂┑锛勫亼閸婃牠鎮у⿰鍫濈；婵炴垶姘ㄦ稉宥夋煛婢跺﹦姘ㄩ柡鈧禒瀣厽婵☆垵娅ｉ敍宥嗐亜閿濆棛鍙€闁哄矉绻濆畷銊╊敊閸撗呮澖闂備礁鎼張顒€煤濠靛牏涓嶆繛鎴炲焹閸嬫捇鏁愭惔婵堟寜闂佺ǹ顑嗛幑鍥ь嚕閹绢喖顫呴柍銉ョ－瑜板懘姊绘担铏瑰笡闁哄被鍔戝畷銉р偓锝庡枟閸嬪倿鏌涢幇闈涙灍闁绘挸绻愰…鍧楁嚋閻㈢偣鈧帡鏌ｉ敐鍛埞妞ゎ叀鍎婚¨渚€鏌涢妸銉у煟鐎殿喛顕ч埥澶婎潨閸℃ê鍏婃俊鐐€栫敮鎺椝囬鐐茬閻犺桨缍嶉弮鍫熷亹闂傚牊绋愬▽顏堟⒑缂佹﹩娈曠紒顔芥尭閻ｅ嘲顫濈捄铏诡唺濠德板€愰崑鎾剁磼閳ь剟宕掑鑲╁數闁荤姾娅ｇ亸銊ヮ潖濡も偓椤法鎲撮崟顒傤槹濠殿喖锕ュ浠嬪箠閺嶎厼鐓橀柣鎰靛墮閻濋亶姊绘担鍛婂暈闁圭ǹ顭烽幆鍕敍濮樿鲸娈鹃梺鍛婄箓鐎氱兘宕ョ€ｎ亶鐔嗛悹杞拌閸庡矂鏌熷畡閭︾吋婵﹨娅ｇ划娆撳箰鎼淬垺瀚抽梻浣藉吹閸犲棝宕濋幋婵堟殾婵°倐鍋撻柣锝嗙箞瀹曠喖顢曢姀鐘愁吇濠碉紕鍋戦崐鏇犳崲閹版澘绠犻悘鐐插⒔椤╁弶绻濇繝鍌滃闁绘挻鐟╅幃妤€鈽夊▎妯煎姺缂備胶濮甸悧妤呭Φ閸曨垰唯闁挎繂鎳愭禒鎯ь渻閵堝啫濡搁柛搴ｆ暬楠炲啫鈻庨幘宕囬獓闂佺懓鐡ㄧ换宥咁焽濮橆厺绻嗛柕鍫濇搐鍟搁梺绋款儑閸嬨倝骞冭铻栭柛娑卞幘椤斿棝姊洪崨濠勨姇婵炲吋鐟︾€靛ジ鎮╃紒妯煎帾婵犮垼娉涢悧鍡涘礉濮樿京纾藉ù锝呭级濞呭棛绱掔紒妯肩疄闁诡喕绮欏Λ鍐归崜浣镐槐闁哄本鐩俊姝岊槻閻㈩垰鐖奸弻宥囩磼濡崵鍙嗛梺瀹犳椤︻垶銈导鏉戠闁绘劦鍓氱欢顓㈡⒒閸屾艾鈧悂宕愭搴ｇ焼濞撴埃鍋撴鐐寸墵椤㈡洟鏁傜紒妯绘珗闂備礁鎲℃笟妤呭垂椤忓牆纾婚柟鐐灱濡插牓鏌熼悜妯诲鞍闁绘繃娲滅槐鎾存媴閸濄儳鍔俊鐐存綑閹芥粓骞戦姀鐘斀閻庯綆浜為崐鐐烘⒑閼测敚褰掓倶濮橆兘鏋嶉柡宥冨妿缁♀偓闂佹眹鍨藉褔鍩㈤崼鐔虹濞达絽鍟块崥妯衡槈濡粍妫冨畷銊╊敇閻樺灚姣庨梻鍌欒兌缁垶宕濆Δ鍛？闁靛牆顦悡鏇㈡煙鏉堥箖妾柣鎾存礃缁绘繈妫冨☉娆樻濡炪倕娴氭禍顏堝蓟閵娿儮妲堟俊顖氥仚瑜旈弻锛勪沪閸撗€妲堥柧浼欑秮閺屾盯鈥﹂幋婵囨闂佽鍎虫晶搴ｅ閼测斁鍋撻崗澶婁壕闂佸憡鍔﹂崰鏍箺閻㈢數纾藉ù锝堟鐢稓绱掔拠鑼闁伙絿鍏樺畷濂稿即閻愬秮鏅犻弻鏇熷緞閸繄浠兼繛瀛樼矒缁犳牕顫忓ú顏勫瀭妞ゆ洖鎳庨崜顓熺箾鐎涙鐭嬬紒顔芥崌閹繝顢曢敃鈧悙濠囨煏婵犲繒鐣辩痪鏉跨Т椤啴濡堕崨顖滅杽闂佺ǹ锕ョ换鍫濐嚕鐠囨祴妲堟慨姗堢到娴滈箖鏌ㄥ┑鍡涱€楀ù婊勭箘閳ь剝顫夊ú鏍儔婵傜ǹ鐒垫い鎺嶇贰閸熷繘鏌涢悩铏闁告帗甯掗埢搴ㄥ箻閹典礁浜惧ù锝呭濞笺劑鏌嶈閸撶喖鐛崘銊㈡瀻闁瑰瓨鏌ㄦ禍鐐箾閹寸偟鎳愰柣鎺斿劋閹便劌顫滈崱妤€骞嬮梺琛″亾濞寸姴顑嗛悡鐔镐繆椤栨繃顏犲ù鐘崇洴閺岋繝宕辫箛鏃€鐝旈梺瀹狀潐閸ㄥ潡銆佸▎鎾村殟闁靛／鍛瀼闂備胶绮幐鍫曞磹濠靛钃熼柡鍥ュ灩闁卞洦绻濋棃娑欐悙缂佹劖绋掔换娑㈠箣閻愭潙纰嶇紓浣割槺閺佺粯淇婇悽绋跨妞ゆ牗鑹鹃崬銊ヮ渻閵堝棗濮︽繝鈶╁亾濠电偛鐭堟禍顏勵潖閾忓湱纾兼俊顖濐嚙閽勫ジ姊虹粙鎸庢崳闁轰浇顕ч锝嗙節濮橆厽娅滄繝銏ｆ硾閿曘倕鐣甸崱娑欌拺缂備焦锚婵牏绱掓担瑙勫唉鐎规洘鍨块獮妯兼嫚閸欏绁舵俊鐐€栭幐鑽ょ矙閹寸偟顩查柣鎰靛墯閸欏繑淇婇婊冨付濞存粓绠栭幃妤€顫濋悙顒€顏�
		rudder=rudder-5;
		// if (fabs(CTRL_DATA_PSI.yd_1[0]-CTRL_DATA_PSI.y_1[0])<=10){
		// 		rudder*=0.7;
		// }
		rudder = -rudder;
		if ((rudder < 10) && (rudder >= 0))
		{
			sprintf(buff_temp, "$0%d;", (int)round(fabs(rudder)));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鐐劤缂嶅﹪寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閻愵剙鍔ょ紓宥咃躬瀵鎮㈤崗灏栨嫽闁诲酣娼ф竟濠偽ｉ鍓х＜闁绘劦鍓欓崝銈囩磽瀹ュ拑韬€殿喖顭烽幃銏ゅ礂鐏忔牗瀚介梺璇查叄濞佳勭珶婵犲伣锝夘敊閸撗咃紲闂佽鍨庨崘锝嗗瘱闂備胶顢婂▍鏇㈠箲閸ヮ剙鐏抽柡鍐ㄧ墕缁€鍐┿亜韫囧海顦﹀ù婊堢畺閺屻劌鈹戦崱娆忓毈缂備降鍔岄妶鎼佸蓟閻斿吋鍎岄柛婵勫劤琚﹂梻浣告惈閻绱炴笟鈧妴浣割潨閳ь剟骞冨▎鎾崇妞ゆ挾鍣ュΛ褔姊婚崒娆戠獢婵炰匠鍏炬稑鈻庨幋鐐存闂佸湱鍎ら〃鎰礊閺嶃劎绡€闂傚牊渚楅崕鎰版煛閸涱喚鍙€闁哄本绋戦埥澶愬础閻愬樊娼绘俊鐐€戦崕鏌ユ嚌妤ｅ啫鐓橀柟瀵稿仜缁犵娀姊虹粙鍖℃敾妞ゃ劌妫濋獮鍫ュΩ閳哄倸鈧鏌﹀Ο渚Ш闁挎稒绋戦埞鎴︽倷閺夋垹浜堕梺鐟扮－閸嬨倕鐣烽崼鏇ㄦ晢濞达綁鏅茬紓鎾剁磽閸屾瑧顦︽い鎴濇閳ь剛鐟抽崶銊モ偓鍨亜閹烘垵顏柍閿嬪灴閺岋綁鎮㈤崨濠勫嚒闂佹娊鏀卞鑽ゆ閹烘鏁嬮柛娑卞幘娴犳悂鎮楃憴鍕闁搞劌娼￠悰顕€宕堕浣镐罕闂佸壊鍋侀崹褰掔嵁濡偐纾藉ù锝呮惈娴滅偓绻濋姀鈭额亪鎮鹃悜绛嬫晢濞达綀顫夐悵椋庣磽閸屾瑧鍔嶉惇澶岀磼鐠囧弶顥㈤柡灞诲€楅崰濠囧础閻愬樊娼婚梻浣告啞閿氶柣掳鍔戦獮鍫ュΩ閿斿墽鐦堥梺鍛婃处閸樿偐绮敓鐘斥拺闁荤喐婢樺Σ濠氭煙閾忣個顏堟偩閻戣棄惟闁挎柨澧介惁鍫ユ⒑閸涘﹤濮傞柛鏂挎湰缁旂喎顓奸崶鈺冿紳闂佺ǹ鏈懝楣冨焵椤掑嫷妫戠紒顔肩墛缁楃喖鍩€椤掑嫨鈧線寮介鐐殿槹濡炪倖鎸鹃崳銉╁磻閵娿儮鏀芥い鏃€鏋绘笟娑㈡煕閹惧娲寸€殿喗濞婇弫鍐磼濞戞艾甯鹃梻濠庡亜濞层垽宕曞畷鍥ь棜闁圭ǹ绨烘禍婊堟煃閸濆嫬鏆欓柛妯绘尦閺岀喖顢欑粵瀣杹闂佽桨鐒﹂崝鏍箚閺傚簱鏀介柛顐ゅ枑濞咃箓姊婚崒娆戝妽閻庣瑳鍛煓闁圭儤顨嗛崕搴€亜閺嶃劌鍤繛鍏肩墵閺屟嗙疀濮樺吋缍堥悗瑙勬礀椤︾敻寮婚弴鐔虹闁割煈鍠栨慨鏇㈡⒑鐠囪尙绠ｉ柣鎺炲閹广垹鈹戦崱蹇旂亖闂佸壊鐓堥崰妤呮倶閹剧粯鈷戦弶鐐村椤︼附銇勯鐘插幋闁绘侗鍣ｅ畷姗€顢欑粵瀣у亾閹邦喚纾藉ù锝呮惈鏍￠梺鐑╂櫓閸ㄥ爼鎮伴灏栨瀻闁规儳纾ˇ銊ヮ渻閵堝懐绠伴悗姘煎弮瀵娊鍩￠崨顔规嫽婵炶揪缍€濡嫰宕ラ悷鎵虫斀妞ゆ棁妫勯崝銈夋煃鐠囪尙效闁轰焦鍔栧鍕節閸曞墎鍚归梻鍌欑窔濞佳囨偋閸℃稒鏅柛鈩兠欢鐐烘煙闁箑骞栭柍褜鍓涢崗姗€骞冨Δ鍛棃婵炴垶鐟﹂崰鎰渻閵堝棙鈷愭繛鑼枎椤繐煤椤忓嫬绐涙繝鐢靛С閼冲墎鎹㈡笟鈧娲川婵炴帟鍋愰崚鎺戔枎韫囨洘娈鹃梺姹囧灮鏋柣鎰攻閵囧嫰骞掑鍫濆帯闂佸憡蓱閹倿骞冨Δ鍛濠㈣泛锕ｆ竟鏇㈡⒑鐠囨彃鍤辩紓宥呮瀹曟粌鈽夊┃鎯у緧濠电姷顣槐鏇㈠磻閹达箑纾归柟杈剧畱閸ㄥ倹绻涘顔荤凹闁哄懏绻堥弻鏇＄疀鐎ｎ亖鍋撻弴鐘典笉闁哄稁鍘介悡蹇涙煕椤愶絿绠栨い銉у仜閳规垿顢涘☉娆忓攭闂佸搫鏈惄顖炲极閸屾粍瀚氶柟缁樺笧椤旀垶绻濋悽闈浶為柛銊ㄦ閺侇噣鍨鹃幇浣圭稁婵犵數濮甸懝鍓у閸忚偐绠鹃柛鈩兠悞鐐繆瀹割喖娅嶆慨濠冩そ瀹曠兘顢樺☉娆忕彵闂備胶枪椤戝懎螞濠靛宓侀柛鎰靛櫘閺佸鏌嶈閸撶喖濡存笟鈧鎾閳╁啯鐝栭梻渚€鈧偛鑻晶鎵磼椤旇偐澧涚€垫澘瀚伴獮鍥敇閻樻彃绠ラ梻浣告惈椤︻垶鎮ч崱妯绘珷濞寸姴顑嗛崑鈺呭级閸碍娅囩痪鎯с偢閺岋絽螣閾忕櫢绱炴繝鈷€鍛毈闁哄矉绱曟禒锕傛倷椤掑偆妲归柣搴ゎ潐濞叉粓宕㈣閸╃偤骞嬮敃鈧粻娑欍亜閹炬剚妾у┑鈥虫川濡叉劙骞掑Δ浣糕偓閿嬨亜閹哄棗浜鹃梺鍛婃煟閸婃繈寮诲☉姗嗘僵妞ゆ帒顦崜鎶芥⒑閻熸壆鐣柛銊ョ秺閸┿儲寰勯幇顒夋綂闂佺粯蓱椤旀牠宕ラ崨瀛樷拻濞达綀娅ｇ敮娑㈡煕閵娾晜娑ч悡銈夋煥濠靛棙澶勬い鎰矙閺屾盯鈥﹂幋婵呯敖缂備胶濞€缁犳牠骞冨Δ鍛瀭妞ゆ劧绲芥禒鈺呮⒑闁偛鑻晶顔姐亜閹存繍妯€闁绘侗鍠涚粻娑樷槈濞嗘劖顏熼梻浣芥硶閸ｏ箓骞忛敓锟� 
		}
		else if ((rudder< 0) && (rudder> -10))
		{

			sprintf(buff_temp, "$-0%d;", (int)round(fabs(rudder)));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鐐劤缂嶅﹪寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閻愵剙鍔ょ紓宥咃躬瀵鎮㈤崗灏栨嫽闁诲酣娼ф竟濠偽ｉ鍓х＜闁绘劦鍓欓崝銈囩磽瀹ュ拑韬€殿喖顭烽幃銏ゅ礂鐏忔牗瀚介梺璇查叄濞佳勭珶婵犲伣锝夘敊閸撗咃紲闂佽鍨庨崘锝嗗瘱闂備胶顢婂▍鏇㈠箲閸ヮ剙鐏抽柡鍐ㄧ墕缁€鍐┿亜韫囧海顦﹀ù婊堢畺閺屻劌鈹戦崱娆忓毈缂備降鍔岄妶鎼佸蓟閻斿吋鍎岄柛婵勫劤琚﹂梻浣告惈閻绱炴笟鈧妴浣割潨閳ь剟骞冨▎鎾崇妞ゆ挾鍣ュΛ褔姊婚崒娆戠獢婵炰匠鍏炬稑鈻庨幋鐐存闂佸湱鍎ら〃鎰礊閺嶃劎绡€闂傚牊渚楅崕鎰版煛閸涱喚鍙€闁哄本绋戦埥澶愬础閻愬樊娼绘俊鐐€戦崕鏌ユ嚌妤ｅ啫鐓橀柟瀵稿仜缁犵娀姊虹粙鍖℃敾妞ゃ劌妫濋獮鍫ュΩ閳哄倸鈧鏌﹀Ο渚Ш闁挎稒绋戦埞鎴︽倷閺夋垹浜堕梺鐟扮－閸嬨倕鐣烽崼鏇ㄦ晢濞达綁鏅茬紓鎾剁磽閸屾瑧顦︽い鎴濇閳ь剛鐟抽崶銊モ偓鍨亜閹烘垵顏柍閿嬪灴閺岋綁鎮㈤崨濠勫嚒闂佹娊鏀卞鑽ゆ閹烘鏁嬮柛娑卞幘娴犳悂鎮楃憴鍕闁搞劌娼￠悰顕€宕堕浣镐罕闂佸壊鍋侀崹褰掔嵁濡偐纾藉ù锝呮惈娴滅偓绻濋姀鈭额亪鎮鹃悜绛嬫晢濞达綀顫夐悵椋庣磽閸屾瑧鍔嶉惇澶岀磼鐠囧弶顥㈤柡灞诲€楅崰濠囧础閻愬樊娼婚梻浣告啞閿氶柣掳鍔戦獮鍫ュΩ閿斿墽鐦堥梺鍛婃处閸樿偐绮敓鐘斥拺闁荤喐婢樺Σ濠氭煙閾忣個顏堟偩閻戣棄惟闁挎柨澧介惁鍫ユ⒑閸涘﹤濮傞柛鏂挎湰缁旂喎顓奸崶鈺冿紳闂佺ǹ鏈懝楣冨焵椤掑嫷妫戠紒顔肩墛缁楃喖鍩€椤掑嫨鈧線寮介鐐殿槹濡炪倖鎸鹃崳銉╁磻閵娿儮鏀芥い鏃€鏋绘笟娑㈡煕閹惧娲寸€殿喗濞婇弫鍐磼濞戞艾甯鹃梻濠庡亜濞层垽宕曞畷鍥ь棜闁圭ǹ绨烘禍婊堟煃閸濆嫬鏆欓柛妯绘尦閺岀喖顢欑粵瀣杹闂佽桨鐒﹂崝鏍箚閺傚簱鏀介柛顐ゅ枑濞咃箓姊婚崒娆戝妽閻庣瑳鍛煓闁圭儤顨嗛崕搴€亜閺嶃劌鍤繛鍏肩墵閺屟嗙疀濮樺吋缍堥悗瑙勬礀椤︾敻寮婚弴鐔虹闁割煈鍠栨慨鏇㈡⒑鐠囪尙绠ｉ柣鎺炲閹广垹鈹戦崱蹇旂亖闂佸壊鐓堥崰妤呮倶閹剧粯鈷戦弶鐐村椤︼附銇勯鐘插幋闁绘侗鍣ｅ畷姗€顢欑粵瀣у亾閹邦喚纾藉ù锝呮惈鏍￠梺鐑╂櫓閸ㄥ爼鎮伴灏栨瀻闁规儳纾ˇ銊ヮ渻閵堝懐绠伴悗姘煎弮瀵娊鍩￠崨顔规嫽婵炶揪缍€濡嫰宕ラ悷鎵虫斀妞ゆ棁妫勯崝銈夋煃鐠囪尙效闁轰焦鍔栧鍕節閸曞墎鍚归梻鍌欑窔濞佳囨偋閸℃稒鏅柛鈩兠欢鐐烘煙闁箑骞栭柍褜鍓涢崗姗€骞冨Δ鍛棃婵炴垶鐟﹂崰鎰渻閵堝棙鈷愭繛鑼枎椤繐煤椤忓嫬绐涙繝鐢靛С閼冲墎鎹㈡笟鈧娲川婵炴帟鍋愰崚鎺戔枎韫囨洘娈鹃梺姹囧灮鏋柣鎰攻閵囧嫰骞掑鍫濆帯闂佸憡蓱閹倿骞冨Δ鍛濠㈣泛锕ｆ竟鏇㈡⒑鐠囨彃鍤辩紓宥呮瀹曟粌鈽夊┃鎯у緧濠电姷顣槐鏇㈠磻閹达箑纾归柟杈剧畱閸ㄥ倹绻涘顔荤凹闁哄懏绻堥弻鏇＄疀鐎ｎ亖鍋撻弴鐘典笉闁哄稁鍘介悡蹇涙煕椤愶絿绠栨い銉у仜閳规垿顢涘☉娆忓攭闂佸搫鏈惄顖炲极閸屾粍瀚氶柟缁樺笧椤旀垶绻濋悽闈浶為柛銊ㄦ閺侇噣鍨鹃幇浣圭稁婵犵數濮甸懝鍓у閸忚偐绠鹃柛鈩兠悞鐐繆瀹割喖娅嶆慨濠冩そ瀹曠兘顢樺☉娆忕彵闂備胶枪椤戝懎螞濠靛宓侀柛鎰靛櫘閺佸鏌嶈閸撶喖濡存笟鈧鎾閳╁啯鐝栭梻渚€鈧偛鑻晶鎵磼椤旇偐澧涚€垫澘瀚伴獮鍥敇閻樻彃绠ラ梻浣告惈椤︻垶鎮ч崱妯绘珷濞寸姴顑嗛崑鈺呭级閸碍娅囩痪鎯с偢閺岋絽螣閾忕櫢绱炴繝鈷€鍛毈闁哄矉绱曟禒锕傛倷椤掑偆妲归柣搴ゎ潐濞叉粓宕㈣閸╃偤骞嬮敃鈧粻娑欍亜閹炬剚妾у┑鈥虫川濡叉劙骞掑Δ浣糕偓閿嬨亜閹哄棗浜鹃梺鍛婃煟閸婃繈寮诲☉姗嗘僵妞ゆ帒顦崜鎶芥⒑閻熸壆鐣柛銊ョ秺閸┿儲寰勯幇顒夋綂闂佺粯蓱椤旀牠宕ラ崨瀛樷拻濞达綀娅ｇ敮娑㈡煕閵娾晜娑ч悡銈夋煥濠靛棙澶勬い鎰矙閺屾盯鈥﹂幋婵呯敖缂備胶濞€缁犳牠骞冨Δ鍛瀭妞ゆ劧绲芥禒鈺呮⒑闁偛鑻晶顔姐亜閹存繍妯€闁绘侗鍠涚粻娑樷槈濞嗘劖顏熼梻浣芥硶閸ｏ箓骞忛敓锟� 
		}
		else {
			sprintf(buff_temp, "$%d;", (int)round(rudder));//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳缍婇弻鐔兼⒒鐎靛壊妲紒鐐劤缂嶅﹪寮婚悢鍏尖拻閻庨潧澹婂Σ顔剧磼閻愵剙鍔ょ紓宥咃躬瀵鎮㈤崗灏栨嫽闁诲酣娼ф竟濠偽ｉ鍓х＜闁绘劦鍓欓崝銈囩磽瀹ュ拑韬€殿喖顭烽幃銏ゅ礂鐏忔牗瀚介梺璇查叄濞佳勭珶婵犲伣锝夘敊閸撗咃紲闂佽鍨庨崘锝嗗瘱闂備胶顢婂▍鏇㈠箲閸ヮ剙鐏抽柡鍐ㄧ墕缁€鍐┿亜韫囧海顦﹀ù婊堢畺閺屻劌鈹戦崱娆忓毈缂備降鍔岄妶鎼佸蓟閻斿吋鍎岄柛婵勫劤琚﹂梻浣告惈閻绱炴笟鈧妴浣割潨閳ь剟骞冨▎鎾崇妞ゆ挾鍣ュΛ褔姊婚崒娆戠獢婵炰匠鍏炬稑鈻庨幋鐐存闂佸湱鍎ら〃鎰礊閺嶃劎绡€闂傚牊渚楅崕鎰版煛閸涱喚鍙€闁哄本绋戦埥澶愬础閻愬樊娼绘俊鐐€戦崕鏌ユ嚌妤ｅ啫鐓橀柟瀵稿仜缁犵娀姊虹粙鍖℃敾妞ゃ劌妫濋獮鍫ュΩ閳哄倸鈧鏌﹀Ο渚Ш闁挎稒绋戦埞鎴︽倷閺夋垹浜堕梺鐟扮－閸嬨倕鐣烽崼鏇ㄦ晢濞达綁鏅茬紓鎾剁磽閸屾瑧顦︽い鎴濇閳ь剛鐟抽崶銊モ偓鍨亜閹烘垵顏柍閿嬪灴閺岋綁鎮㈤崨濠勫嚒闂佹娊鏀卞鑽ゆ閹烘鏁嬮柛娑卞幘娴犳悂鎮楃憴鍕闁搞劌娼￠悰顕€宕堕浣镐罕闂佸壊鍋侀崹褰掔嵁濡偐纾藉ù锝呮惈娴滅偓绻濋姀鈭额亪鎮鹃悜绛嬫晢濞达綀顫夐悵椋庣磽閸屾瑧鍔嶉惇澶岀磼鐠囧弶顥㈤柡灞诲€楅崰濠囧础閻愬樊娼婚梻浣告啞閿氶柣掳鍔戦獮鍫ュΩ閿斿墽鐦堥梺鍛婃处閸樿偐绮敓鐘斥拺闁荤喐婢樺Σ濠氭煙閾忣個顏堟偩閻戣棄惟闁挎柨澧介惁鍫ユ⒑閸涘﹤濮傞柛鏂挎湰缁旂喎顓奸崶鈺冿紳闂佺ǹ鏈懝楣冨焵椤掑嫷妫戠紒顔肩墛缁楃喖鍩€椤掑嫨鈧線寮介鐐殿槹濡炪倖鎸鹃崳銉╁磻閵娿儮鏀芥い鏃€鏋绘笟娑㈡煕閹惧娲寸€殿喗濞婇弫鍐磼濞戞艾甯鹃梻濠庡亜濞层垽宕曞畷鍥ь棜闁圭ǹ绨烘禍婊堟煃閸濆嫬鏆欓柛妯绘尦閺岀喖顢欑粵瀣杹闂佽桨鐒﹂崝鏍箚閺傚簱鏀介柛顐ゅ枑濞咃箓姊婚崒娆戝妽閻庣瑳鍛煓闁圭儤顨嗛崕搴€亜閺嶃劌鍤繛鍏肩墵閺屟嗙疀濮樺吋缍堥悗瑙勬礀椤︾敻寮婚弴鐔虹闁割煈鍠栨慨鏇㈡⒑鐠囪尙绠ｉ柣鎺炲閹广垹鈹戦崱蹇旂亖闂佸壊鐓堥崰妤呮倶閹剧粯鈷戦弶鐐村椤︼附銇勯鐘插幋闁绘侗鍣ｅ畷姗€顢欑粵瀣у亾閹邦喚纾藉ù锝呮惈鏍￠梺鐑╂櫓閸ㄥ爼鎮伴灏栨瀻闁规儳纾ˇ銊ヮ渻閵堝懐绠伴悗姘煎弮瀵娊鍩￠崨顔规嫽婵炶揪缍€濡嫰宕ラ悷鎵虫斀妞ゆ棁妫勯崝銈夋煃鐠囪尙效闁轰焦鍔栧鍕節閸曞墎鍚归梻鍌欑窔濞佳囨偋閸℃稒鏅柛鈩兠欢鐐烘煙闁箑骞栭柍褜鍓涢崗姗€骞冨Δ鍛棃婵炴垶鐟﹂崰鎰渻閵堝棙鈷愭繛鑼枎椤繐煤椤忓嫬绐涙繝鐢靛С閼冲墎鎹㈡笟鈧娲川婵炴帟鍋愰崚鎺戔枎韫囨洘娈鹃梺姹囧灮鏋柣鎰攻閵囧嫰骞掑鍫濆帯闂佸憡蓱閹倿骞冨Δ鍛濠㈣泛锕ｆ竟鏇㈡⒑鐠囨彃鍤辩紓宥呮瀹曟粌鈽夊┃鎯у緧濠电姷顣槐鏇㈠磻閹达箑纾归柟杈剧畱閸ㄥ倹绻涘顔荤凹闁哄懏绻堥弻鏇＄疀鐎ｎ亖鍋撻弴鐘典笉闁哄稁鍘介悡蹇涙煕椤愶絿绠栨い銉у仜閳规垿顢涘☉娆忓攭闂佸搫鏈惄顖炲极閸屾粍瀚氶柟缁樺笧椤旀垶绻濋悽闈浶為柛銊ㄦ閺侇噣鍨鹃幇浣圭稁婵犵數濮甸懝鍓у閸忚偐绠鹃柛鈩兠悞鐐繆瀹割喖娅嶆慨濠冩そ瀹曠兘顢樺☉娆忕彵闂備胶枪椤戝懎螞濠靛宓侀柛鎰靛櫘閺佸鏌嶈閸撶喖濡存笟鈧鎾閳╁啯鐝栭梻渚€鈧偛鑻晶鎵磼椤旇偐澧涚€垫澘瀚伴獮鍥敇閻樻彃绠ラ梻浣告惈椤︻垶鎮ч崱妯绘珷濞寸姴顑嗛崑鈺呭级閸碍娅囩痪鎯с偢閺岋絽螣閾忕櫢绱炴繝鈷€鍛毈闁哄矉绱曟禒锕傛倷椤掑偆妲归柣搴ゎ潐濞叉粓宕㈣閸╃偤骞嬮敃鈧粻娑欍亜閹炬剚妾у┑鈥虫川濡叉劙骞掑Δ浣糕偓閿嬨亜閹哄棗浜鹃梺鍛婃煟閸婃繈寮诲☉姗嗘僵妞ゆ帒顦崜鎶芥⒑閻熸壆鐣柛銊ョ秺閸┿儲寰勯幇顒夋綂闂佺粯蓱椤旀牠宕ラ崨瀛樷拻濞达綀娅ｇ敮娑㈡煕閵娾晜娑ч悡銈夋煥濠靛棙澶勬い鎰矙閺屾盯鈥﹂幋婵呯敖缂備胶濞€缁犳牠骞冨Δ鍛瀭妞ゆ劧绲芥禒鈺呮⒑闁偛鑻晶顔姐亜閹存繍妯€闁绘侗鍠涚粻娑樷槈濞嗘劖顏熼梻浣芥硶閸ｏ箓骞忛敓锟� 
		}
		write(fd[1], buff_temp, strlen(buff_temp));
		printf("rudder %s\n", buff_temp);
}

//闂傚倸鍊搁崐鎼佸磹閹间礁纾归柟闂寸绾惧綊鏌熼梻瀵割槮缁炬儳婀遍埀顒傛嚀鐎氼參宕崇壕瀣ㄤ汗闁圭儤鍨归崐鐐差渻閵堝棗绗掗柨鏇缁瑨绠涢弮鍌滅槇闂侀潧楠忕徊鍓ф兜閻愵兙浜滈柟瀛樼箖閸犳﹢鏌曢崱妤佸殗妤犵偞鎹囬獮鎴澪旈埀顒傜礊婵犲洤绠栭柍杞扮贰閸熷懏銇勯弮鍌氬付濠㈢懓鐗忕槐鎾诲磼濞嗘帩鍞归梺绋款儐閹告悂鈥﹂崸妤佸殝闂傚牊绋戦～搴ㄦ⒑閸涘﹦鎳勯柟鐟版喘瀵鈽夐姀鐘栥劑鏌ㄥ┑鍡樺櫣妞ゎ剙顦辩槐鎾存媴閹绘帊澹曢梻浣告啞閸旓附绂嶉弽顓炵；闁规崘鍩栭崰鍡涙煕閺囥劌澧版い锔哄劦閹鈻撻崹顔界亪闂佺粯鐗曢妶鎼佹偘椤曗偓瀹曞ジ濡烽妷搴樻櫊閺屾洘寰勫Ο鐑樼亶闁诲酣娼ч惌鍌炲蓟閿濆鍋愰柛娆忣槺閳规盯鎮楀▓鍨灍闁规瓕宕电划鈺呮偄閻撳骸宓嗛梺闈涢獜缁辨洟宕㈡禒瀣厵闁稿繗鍋愰弳姗€鏌涙繛鍨偓鏇⑩€﹂崶顒€绠涙い鎾跺Х椤旀洟姊洪崨濠勬噧闁挎稑鍟撮獮瀣偐閸愭彃绨ユ繝鐢靛仦閸ㄥ爼鎮疯瀵囧焵椤掑嫭鈷戦柟鑲╁仜閸斺偓闂佸憡娲﹂崢鎼佸磻閹炬椿鏁嗛柛鏇ㄥ厴閹锋椽姊洪懡銈呮瀾婵犮垺锕㈤崺娑㈠籍閸屾粎锛滃銈嗘礀閹冲酣鎮橀敂閿亾濞堝灝鏋熼柣鎿勭節閻涱噣寮介妸锕€顎撻梺闈╁瘜閸樼厧顕ｉ幎鑺モ拻濞达綀娅ｇ敮娑欑箾閸欏澧电€规洘鍔欏畷鐑筋敇濞戞ü澹曞┑顔筋焽閸嬫挾鈧熬鎷�
void pwm_thrust(double volt){
	memset(buff_temp, 0, sizeof(buff_temp));
    sprintf(buff_temp, "$%.1f;", volt);
	printf("thrust %s\n", buff_temp);
    write(fd[5], buff_temp, strlen(buff_temp));
}

//AD闂傚倸鍊搁崐鎼佸磹閹间礁纾归柣鎴ｅГ閸婂潡鏌ㄩ弴姘舵濞存粌缍婇弻娑㈠箛閻㈤潧甯掑┑鐐叉▕娴滄繈寮插┑瀣厱閻忕偛澧介埥澶娒瑰⿰鍫滄喚婵﹥妞藉畷銊︾節鎼淬垻鏆梻浣呵归オ鐢电礊娓氣偓楠炲啴濮€閵堝棗浜楅柟鑹版彧缁茶偐妲愬⿰鍫熲拻濞达絿鎳撻崝銈嗙箾鐎涙ê鍝虹€规洘鍨垮畷鐔碱敆閸屻倖绁梻浣芥硶閸ｏ箓骞忛敓锟�
void AD_sample(int fd_index) 
{	
	char *filedata;
	switch (select(maxfd[fd_index] + 1, &rd[fd_index], NULL, NULL, NULL))     
	{
	case -1: perror("select:");
		break;
	case 0:
		perror("AD:read_0\n");
		break;
	default:
		if (FD_ISSET(fd[fd_index], &rd[fd_index]))
		{
			int temp;
			memset(buff_AD, 0,  sizeof(buff_AD));
			if ((temp=read(fd[fd_index], buff_AD, sizeof(buff_AD))) < 0)
				perror("AD:read_fail");
			else
			{
				//printf("buff_AD = %s\n",buff_AD);
				buff_AD[temp] = '\0';

				if ((filedata = strstr(buff_AD, ">")) != NULL)
				{
					if (((filedata[1] == '+') || (filedata[1] == '-'))        
						&& ((filedata[8] == '+') || (filedata[8] == '-'))
						&& ((filedata[15] == '+') || (filedata[15] == '-'))
						&& ((filedata[22] == '+') || (filedata[22] == '-'))
						&& ((filedata[29] == '+') || (filedata[29] == '-'))
						&& ((filedata[36] == '+') || (filedata[36] == '-'))
						&& ((filedata[43] == '+') || (filedata[43] == '-'))
						&& ((filedata[50] == '+') || (filedata[50] == '-')))
					{	
						pthread_mutex_lock(&AD_DATA.mutex); 
						strncpy(buff_temp, filedata + 43, 7);
						buff_temp[7] = '\0';
						AD_DATA.vol = strtod(buff_temp, NULL);

						strncpy(buff_temp, filedata + 22, 7);
						buff_temp[7] = '\0';
						tcflush(fd[fd_index], TCIFLUSH);	
						AD_DATA.rudder =-(-120.29644- (strtod(buff_temp, NULL)) / 0.0185)-274.902;
						pthread_mutex_unlock(&AD_DATA.mutex); 
					}
				}
				else { printf("filedata information error!!!");
								tcflush(fd[fd_index], TCIFLUSH); }
				return;
			}		
			}
		}

	}


void*  AD_thread() {
        while(1){
		AD_sample(6);
        usleep(50000); // 缂傚倸鍊搁崐鎼佸磹閹间礁纾归柣鎴ｅГ閸婂潡鏌ㄩ弬鍨挃闁活厽鐟╅弻鐔封枎闄囬褍煤椤撯偓鈧礁鈽夊Ο宄扮墯闂佸憡娲熷褎绂掑ú顏呪拻濞达綀濮ょ涵鍫曟煕閿濆繒鐣垫鐐茬箻閺佹捇鏁撻敓锟�50婵犵數濮烽弫鍛婃叏閻㈠壊鏁婇柡宥庡幖闂傤垱銇勯弽銊х煂缂佲偓婵犲洦鐓曢柍鈺佸暟閳藉鐥幆褜鐓奸柡灞剧洴閸╁嫰宕橀妸銉︾亞缂傚倸鍊哥粔鐢告偋閻樿钃熼柕濞炬櫆閸嬪棝鏌涚仦鍓р槈妞ゅ骏鎷�,闂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾妤犵偛顦甸弫鎾绘偐閼碱剦妲烽梻浣告惈濞层劍鎱ㄩ悜鑺ュ剹闁瑰墽绮悡鐔兼煏韫囨洖孝妞ゃ儱绻橀弻鈩冩媴缁嬫寧娈婚梺鍝勮閸婃洟婀侀柣搴秵閸嬪懘鎮甸幒妤佲拺缂備焦锚缁楁帡鏌ㄩ弴妯哄姢闁瑰箍鍨归埞鎴犫偓锝庡亽濡啫鈹戦悙鏉戠仴闁哥喐瀵ч幈銊モ槈濡攱鏂€闂佺偨鍎遍崯璺ㄧ棯瑜旈弻鐔碱敊閻撳簶鍋撻幖渚婄稏闊洦鎷嬪ú顏嶆晜闁告洦鍙庨崬浠嬫⒒娴ｅ憡璐￠柛搴涘€濋獮鎰板箹娴ｂ偓閸ヮ剙鐓涢柛娑卞枓閹疯櫣绱撻崒娆戝妽闁挎洍鏅涢埢鎾绘晲婢跺鍘甸梺鍛婂灟閸婃牜鈧熬鎷�
        }
}